<%# filepath: /workspaces/hockey_bet/lib/standings.html.erb %>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>NHL Standings</title>
    <link rel='stylesheet' href='https://unpkg.com/@primer/css@^20.2.4/dist/primer.css'>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- Home Screen App Icons and Meta -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NHL Standings">
    <meta name="theme-color" content="#041E42">
    
    <style>
        @media screen and (max-width: 768px) {
            .mobile-hidden {
                display: none;
            }
            .no-fan-name {
                display: none;
            }
            .responsive-table {
                font-size: 0.85em;
            }
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            .stat-card {
                padding: 8px 12px !important;
            }
            .stat-card .h4 {
                font-size: 1em !important;
                margin-bottom: 4px !important;
            }
            .stat-card p {
                font-size: 0.9em;
                line-height: 1.3;
            }
            .bet-stats-section {
                padding: 8px !important;
                margin-bottom: 12px !important;
            }
            .bet-stats-section .h3 {
                font-size: 1.1em !important;
                margin-bottom: 8px !important;
            }
            .matchup-item {
                padding: 8px 0 !important;
            }
            .matchup-header .h4 {
                font-size: 0.95em !important;
            }
            .matchup-details {
                font-size: 0.85em;
            }
        }
        .hidden {
            display: none;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .status-icon {
            padding: 0 2px;
        }
        .status-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            margin-bottom: 16px;
        }
        .status-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 4px;
        }
        .fan-team-indicator {
            font-weight: bold;
        }
        .bet-stats-section {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(255, 184, 0, 0.1) 100%);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-medal {
            font-size: 1.2em;
            margin-right: 8px;
        }
        .matchup-item {
            padding: 12px 0;
        }
        .matchup-header {
            font-size: 1.1em;
        }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body class='m-2' data-color-mode='auto' data-light-theme='light' data-dark-theme='dark_dimmed'>
    <h1 class='color-fg-success'>NHL Team Standings</h1>
    <p>Last updated at: <%= Time.parse(last_updated.to_s).strftime("%Y-%m-%d %H:%M:%S") %> Pacific Time</p>
    
    <div class="status-legend">
        <% PLAYOFF_STATUS.each do |key, status| %>
            <div class="status-item <%= status[:class] %> color-fg-on-emphasis">
                <span class="status-icon" aria-hidden="true"><%= status[:icon] %></span>
                <span><%= status[:label] %></span>
            </div>
        <% end %>
    </div>

    <!-- Bet Stats Section -->
    <% if bet_stats && bet_stats[:top_winners] && bet_stats[:top_winners].any? %>
    <div class="bet-stats-section border rounded-2 p-3 mb-3 color-bg-subtle">
        <h2 class='h3 mb-3'>üèÜ Fan League Stats & Bragging Rights üèÜ</h2>
        
        <div class="stats-grid">
            <!-- Top Winners -->
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Top Winners</h3>
                <ul class="list-style-none">
                    <% bet_stats[:top_winners].each_with_index do |stat, idx| %>
                        <li class="py-1">
                            <span class="stat-medal"><%= ['ü•á', 'ü•à', 'ü•â'][idx] %></span>
                            <strong><%= stat[:fan] %></strong> (<%= stat[:team] %>): <%= stat[:display] %> wins
                        </li>
                    <% end %>
                </ul>
            </div>

            <!-- Top Losers -->
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-danger'>Most Losses (Wall of Shame)</h3>
                <ul class="list-style-none">
                    <% bet_stats[:top_losers].each_with_index do |stat, idx| %>
                        <li class="py-1">
                            <span class="stat-medal"><%= ['üí©', 'ü§¶', 'üò¢'][idx] %></span>
                            <strong><%= stat[:fan] %></strong> (<%= stat[:team] %>): <%= stat[:display] %> losses
                        </li>
                    <% end %>
                </ul>
            </div>

            <!-- Most Dominant -->
            <% if bet_stats[:most_dominant] && bet_stats[:most_dominant].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Most Dominant üëë</h3>
                <% bet_stats[:most_dominant].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Brick Wall -->
            <% if bet_stats[:brick_wall] && bet_stats[:brick_wall].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Brick Wall üß±</h3>
                <% bet_stats[:brick_wall].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Longest Win Streak -->
            <% if bet_stats[:longest_win_streak] && bet_stats[:longest_win_streak].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>On Fire üî•</h3>
                <% bet_stats[:longest_win_streak].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Longest Lose Streak -->
            <% if bet_stats[:longest_lose_streak] && bet_stats[:longest_lose_streak].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-danger'>Ice Cold üßä</h3>
                <% bet_stats[:longest_lose_streak].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Best Point Differential -->
            <% if bet_stats[:best_point_differential] && bet_stats[:best_point_differential].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Best Goal Differential üéØ</h3>
                <% bet_stats[:best_point_differential].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Glass Cannon -->
            <% if bet_stats[:glass_cannon] && bet_stats[:glass_cannon].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-attention'>Glass Cannon üí•</h3>
                <% bet_stats[:glass_cannon].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Comeback Kid -->
            <% if bet_stats[:comeback_kid] && bet_stats[:comeback_kid].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-accent'>Comeback Kid üí™</h3>
                <% bet_stats[:comeback_kid].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Overtimer -->
            <% if bet_stats[:overtimer] && bet_stats[:overtimer].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-muted'>Overtimer ‚è±Ô∏è</h3>
                <% bet_stats[:overtimer].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Point Scrounger -->
            <% if bet_stats[:point_scrounger] && bet_stats[:point_scrounger].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-muted'>Point Scrounger ü™ô</h3>
                <% bet_stats[:point_scrounger].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Fan Crusher (Best vs other fans) -->
            <% if bet_stats[:fan_crusher] && bet_stats[:fan_crusher].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-success-subtle">
                <h3 class='h4 color-fg-success'>Fan Crusher üèÜ</h3>
                <% bet_stats[:fan_crusher].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Fan Fodder (Worst vs other fans) -->
            <% if bet_stats[:fan_fodder] && bet_stats[:fan_fodder].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-danger-subtle">
                <h3 class='h4 color-fg-danger'>Fan Fodder üéØ</h3>
                <% bet_stats[:fan_fodder].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>
        </div>

        <!-- Head-to-Head Matrix -->
        <% if bet_stats[:head_to_head_matrix] && bet_stats[:head_to_head_matrix].any? %>
        <div class="stat-card border rounded-2 p-3 mb-3 color-bg-accent-subtle">
            <h3 class='h3 color-fg-accent'>üìä Head-to-Head Records üìä</h3>
            <p class="text-small color-fg-muted mb-2">How each fan's team performed against other fan teams this season</p>
            <p class="text-small color-fg-muted mb-3"><strong>How to read:</strong> Each cell shows the row team's record vs. the column team in format <strong>Wins-Losses-OT Losses</strong> (e.g., "2-1-0" means 2 wins, 1 regulation/shootout loss, 0 overtime losses)</p>
            <div style="overflow-x: auto;">
                <table class="table-auto width-full text-small">
                    <thead>
                        <tr class="border-bottom">
                            <th scope="col" class="p-2 text-left">Fan</th>
                            <% 
                              fan_abbrevs = bet_stats[:head_to_head_matrix].keys 
                              fan_list = fan_abbrevs.map { |abbrev| manager_team_map[abbrev] }
                            %>
                            <% fan_list.each do |fan| %>
                                <th scope="col" class="p-2 text-center" style="min-width: 60px;"><%= fan %></th>
                            <% end %>
                        </tr>
                    </thead>
                    <tbody>
                        <% fan_abbrevs.each_with_index do |team_abbrev, idx| %>
                        <tr class="<%= 'border-bottom' if idx < fan_abbrevs.length - 1 %>">
                            <td class="p-2 text-left"><strong><%= manager_team_map[team_abbrev] %></strong></td>
                            <% fan_abbrevs.each do |opp_abbrev| %>
                                <td class="p-2 text-center">
                                    <% if team_abbrev == opp_abbrev %>
                                        <span class="color-fg-muted">‚Äî</span>
                                    <% else %>
                                        <% record = bet_stats[:head_to_head_matrix][team_abbrev][opp_abbrev] %>
                                        <% if record && (record[:wins] + record[:losses] + record[:ot_losses]) > 0 %>
                                            <span class="<%= record[:wins] > (record[:losses] + record[:ot_losses]) ? 'color-fg-success' : (record[:wins] < (record[:losses] + record[:ot_losses]) ? 'color-fg-danger' : 'color-fg-muted') %>">
                                                <%= record[:wins] %>-<%= record[:losses] %>-<%= record[:ot_losses] %>
                                            </span>
                                        <% else %>
                                            <span class="color-fg-muted">0-0-0</span>
                                        <% end %>
                                    <% end %>
                                </td>
                            <% end %>
                        </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        </div>
        <% end %>

        <!-- Upcoming Fan Matchups -->
        <% if bet_stats[:upcoming_fan_matchups] && bet_stats[:upcoming_fan_matchups].any? %>
        <div class="stat-card border rounded-2 p-3 mb-3 color-bg-attention-subtle">
            <h3 class='h3 color-fg-attention'>üî• Upcoming Fan vs Fan Battles üî•</h3>
            <div class="matchups-list">
                <% bet_stats[:upcoming_fan_matchups].each_with_index do |matchup, idx| %>
                    <div class="matchup-item border-bottom py-3 <%= 'border-bottom-0' if idx == bet_stats[:upcoming_fan_matchups].size - 1 %>">
                        <div class="matchup-header mb-2">
                            <strong class="h4">
                                <%= matchup[:away_fan] %> (<%= matchup[:away_team] %>)
                                vs 
                                <%= matchup[:home_fan] %> (<%= matchup[:home_team] %>)
                            </strong>
                        </div>
                        <div class="matchup-details">
                            <span class="text-small">
                                Records: <%= matchup[:away_wins] %>W vs <%= matchup[:home_wins] %>W | 
                                Points: <%= matchup[:away_points] %> vs <%= matchup[:home_points] %>
                                <% if matchup[:game_time] && matchup[:game_time] != 'None' && matchup[:game_time] != 'TBD' %>
                                    <br>
                                    <strong>Game Time:</strong> <%= format_game_time_full(convert_utc_to_pacific(matchup[:game_time])) %>
                                <% end %>
                            </span>
                        </div>
                    </div>
                <% end %>
            </div>
        </div>
        <% end %>
    </div>
    <% end %>
    
    <div class="responsive-table overflow-auto">
        <table class='color-shadow-large'>
            <thead class='color-bg-accent-emphasis color-fg-on-emphasis mr-1'>
                <tr>
                    <th scope='col' class='p-2 border'>Team</th>
                    <th scope='col' class='p-2 border'>Fan</th>
                    <th scope='col' class='p-2 border'>Status</th>
                    <th scope='col' class='p-2 border'>W</th>
                    <th scope='col' class='p-2 border'>L</th>
                    <th scope='col' class='p-2 border'>OTL</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Streak</th>
                    <th scope='col' class='p-2 border'>Pts</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Pt %</th>
                    <th scope='col' class='p-2 border mobile-hidden'>GPG</th>
                    <th scope='col' class='p-2 border mobile-hidden'>GA</th>
                    <th scope='col' class='p-2 border mobile-hidden'>League Rank</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Conference</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Conf. Rank</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Division</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Div. Rank</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Wildcard</th>
                    <th scope='col' class='p-2 border'>Next Game</th>
                    <th scope='col' class='p-2 border'>Next Opponent</th>
                </tr>
            </thead>
            <tbody>
                <% teams.each do |team| %>
                    <% 
                    status = playoff_status_for(team)
                    status_info = PLAYOFF_STATUS[status]
                    no_fan_class = manager_team_map[team['teamAbbrev']['default']] == "N/A" ? 'no-fan-name' : ''
                    team_abbrev = team['teamAbbrev']['default']
                    next_game = next_games[team_abbrev]
                    next_game_utc = next_game ? next_game['startTimeUTC'] : 'TBD'
                    next_game_pacific = next_game_utc != 'TBD' ? convert_utc_to_pacific(next_game_utc) : 'TBD'
                    opponent_name = get_opponent_name(next_game, team_abbrev)
                    is_fan_team_opponent = next_game && next_game['isFanTeamOpponent']
                    %>
                    <tr class='<%= "#{status_info[:class]} color-fg-on-emphasis mr-1 #{no_fan_class}" %>'>
                        <td class='p-2 border'><%= team['teamName']['default'] || 'N/A' %></td>
                        <td class='p-2 border <%= manager_team_map[team_abbrev] != "N/A" ? "fan-team-indicator" : "" %>'>
                            <%= manager_team_map[team_abbrev] || 'N/A' %>
                        </td>
                        <td class='p-2 border'>
                            <span class="status-icon" aria-label="<%= status_info[:aria_label] %>" role="img">
                                <%= status_info[:icon] %>
                            </span>
                        </td>
                        <td class='p-2 border'><%= team['wins'] || 'N/A' %></td>
                        <td class='p-2 border'><%= team['losses'] || 'N/A' %></td>
                        <td class='p-2 border'><%= team['otLosses'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['streakCode'] || 'N/A' %></td>
                        <td class='p-2 border'><%= team['points'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['pointPctg'] ? '%.2f' % (team['pointPctg'] * 100) : 'N/A' %>%</td>
                        <td class='p-2 border mobile-hidden'><%= team['goalsForPctg'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['goalAgainst'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['leagueSequence'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['conferenceName'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['conferenceSequence'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['divisionName'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['divisionSequence'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['wildcardSequence'] || 'N/A' %></td>
                        <td class='p-2 border'><%= format_game_time(next_game_pacific) %></td>
                        <td class='p-2 border'>
                            <%= opponent_name %>
                            <% if is_fan_team_opponent %>
                                <span aria-label="Playing against a fan-owned team" role="img">üî•</span>
                            <% end %>
                        </td>
                    </tr>
                <% end %>
            </tbody>
        </table>
    </div>
    
    <div class="border-top border-bottom border-gray-light mt-3 pt-3 pb-3">
        <button id='toggleButton' class='btn btn-primary color-bg-accent-emphasis color-fg-on-emphasis mr-1 mb-1' aria-label="Toggle showing teams without fans">
            Toggle Teams Without Fans
        </button>
        <button id='toggleStatsButton' class='btn btn-primary color-bg-accent-emphasis color-fg-on-emphasis mr-1 mb-1' aria-label="Toggle showing extended statistics">
            Toggle Extended Stats
        </button>
    </div>

    <script>
        document.getElementById('toggleButton').addEventListener('click', function () {
            var noFanRows = document.querySelectorAll('tr.no-fan-name');
            noFanRows.forEach(function (row) {
                row.classList.toggle('hidden');
            });
        });

        document.getElementById('toggleStatsButton').addEventListener('click', function () {
            var statColumns = document.querySelectorAll('.mobile-hidden');
            statColumns.forEach(function (column) {
                column.style.display = (column.style.display === 'none') ? 'table-cell' : 'none';
            });
        });
    </script>
</body>
</html>
