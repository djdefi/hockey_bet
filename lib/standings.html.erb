<%# filepath: /workspaces/hockey_bet/lib/standings.html.erb %>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>NHL Standings</title>
    
    <!-- Critical CSS inlined for instant render -->
    <style>
        :root{--bg-primary:#0b162a;--bg-card:#1a253a;--text-primary:#fff;--text-secondary:#8da1b9;--accent-green:#21d19f;--border-color:#2a3a52}*{box-sizing:border-box}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background-color:var(--bg-primary);color:var(--text-primary);margin:0;padding:0 0 80px;line-height:1.6;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}h1,h2,h3{font-weight:700;margin-top:0}h1{font-size:1.75rem;margin-bottom:.5rem}.app-container{max-width:100%;margin:0 auto;padding:1rem;padding-bottom:100px}header{margin-bottom:1rem}.desktop-tabs{display:none}@media(min-width:768px){.desktop-tabs{display:flex}}
    </style>
    
    <!-- Load full styles synchronously for reliability -->
    <link rel='stylesheet' href='styles.css'>
    
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Home Screen App Icons and Meta -->
    <link rel="manifest" href="site.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NHL Fan League">
    <meta name="theme-color" content="#0b162a">
    
    <!-- Performance Optimization: Preconnect to external origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://api-web.nhle.com">
    
    <!-- Chart.js - Vendored with deferred loading for performance -->
    <script src="vendor/chart.umd.js" defer></script>
    
    <!-- Performance utilities - Core Web Vitals monitoring and lazy loading -->
    <script src="performance-utils.js" defer></script>
    
    <!-- Accessibility enhancements - Keyboard shortcuts and focus management -->
    <script src="accessibility.js" defer></script>
    
    <!-- Social features - Reactions, celebrations, and engagement -->
    <script src="social-features.js" defer></script>
    
    <!-- Mobile Gestures - Enhanced touch interactions -->
    <script src="mobile-gestures.js" defer></script>
    
    <!-- PWA Install Promotion - Smart "Add to Home Screen" banner -->
    <script src="pwa-install.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="mb-3" role="banner">
            <h1>üèí NHL Fan League</h1>
            <p class="text-secondary" style="font-size: 0.9rem;">Last updated: <%= Time.parse(last_updated.to_s).strftime("%Y-%m-%d %H:%M:%S") %> PT</p>
        </header>

        <!-- Desktop Tabs (hidden on mobile) -->
        <nav class="desktop-tabs" role="navigation" aria-label="Main navigation">
            <button class="desktop-tab active" data-tab="league" aria-label="View League tab" aria-current="page">League</button>
            <button class="desktop-tab" data-tab="matchups" aria-label="View Matchups tab">Matchups</button>
            <button class="desktop-tab" data-tab="standings" aria-label="View Standings tab">Standings</button>
            <button class="desktop-tab" data-tab="playoff-odds" aria-label="View Playoff Odds tab">Playoff Odds</button>
            <button class="desktop-tab" data-tab="trends" aria-label="View Trends tab">Trends</button>
        </nav>

        <!-- Tab: League (Fan Stats Dashboard) -->
        <div id="league-tab" class="tab-section active" role="tabpanel" aria-label="League statistics">
            
            <!-- Top 3 Leaders - Compact -->
            <% if bet_stats && bet_stats[:best_cup_odds] && bet_stats[:best_cup_odds].any? %>
            <div class="leaders-compact-card" role="region" aria-label="Top 3 league leaders">
                <% 
                top_3 = bet_stats[:best_cup_odds].first(3)
                rank_badges = ['ü•á', 'ü•à', 'ü•â']
                rank_labels = ['#1', '#2', '#3']
                achievement_emojis = ['üèÜ', 'üëë', 'üí™']
                achievement_labels = ['League Leader', 'Strong Contender', 'Top Threat']
                %>
                
                <% top_3.each_with_index do |leader, index| %>
                <div class="leader-compact-item <%= 'leader-first' if index == 0 %>" role="article" aria-label="<%= rank_labels[index] %>: <%= leader[:fan] %>">
                    <div class="leader-rank-badge rank-<%= index + 1 %>">
                        <span class="rank-emoji"><%= rank_badges[index] %></span>
                        <span class="rank-text"><%= rank_labels[index] %></span>
                    </div>
                    <div class="leader-identity">
                        <div class="leader-fan-name"><%= leader[:fan] %></div>
                        <div class="leader-team-name"><%= leader[:team] %></div>
                        <div class="leader-achievement">
                            <span><%= achievement_emojis[index] %></span>
                            <span><%= achievement_labels[index] %></span>
                        </div>
                    </div>
                    <div class="leader-stats-inline">
                        <div class="leader-stat">
                            <span class="leader-stat-value"><%= leader[:wins] || 0 %>-<%= leader[:losses] || 0 %>-<%= leader[:ot_losses] || 0 %></span>
                            <span class="leader-stat-label">Record</span>
                        </div>
                        <div class="leader-stat">
                            <span class="leader-stat-value"><%= leader[:points] || 0 %></span>
                            <span class="leader-stat-label">Points</span>
                        </div>
                        <div class="leader-stat">
                            <span class="leader-stat-value"><%= leader[:gpg] || '0.0' %></span>
                            <span class="leader-stat-label">GPG</span>
                        </div>
                        <div class="leader-stat">
                            <span class="leader-stat-value"><%= leader[:streak] || '-' %></span>
                            <span class="leader-stat-label">Streak</span>
                        </div>
                    </div>
                </div>
                <% end %>
            </div>
            <% end %>
            
            <!-- Featured Matchup / Voting Section (Dense Layout) -->
            <% if bet_stats && bet_stats[:upcoming_fan_matchups] && bet_stats[:upcoming_fan_matchups].any? %>
            <div class="featured-matchup" role="region" aria-label="Featured upcoming matchup">
                <h3 class="section-heading">‚ö° Featured Matchup</h3>
                <% matchup = bet_stats[:upcoming_fan_matchups].first %>
                <% 
                away_achievement = get_fan_achievement(matchup[:away_fan], bet_stats)
                home_achievement = get_fan_achievement(matchup[:home_fan], bet_stats)
                
                # Calculate prediction using helper
                prediction = calculate_matchup_prediction(
                  matchup[:home_points],
                  matchup[:away_points],
                  matchup[:home_streak],
                  matchup[:away_streak]
                )
                
                predicted_winner = ''
                prediction_confidence = ''
                if prediction[:winner] == 'home'
                  predicted_winner = matchup[:home_fan]
                  prediction_confidence = "#{prediction[:confidence]}%"
                elsif prediction[:winner] == 'away'
                  predicted_winner = matchup[:away_fan]
                  prediction_confidence = "#{prediction[:confidence]}%"
                end
                
                # Format game time
                game_time_formatted = ''
                if matchup[:game_time]
                  begin
                    game_time = Time.parse(matchup[:game_time])
                    game_time_pst = game_time.getlocal('-08:00')
                    game_time_formatted = game_time_pst.strftime("%a %b %-d ‚Ä¢ %-I:%M %p PT")
                  rescue
                    game_time_formatted = 'TBD'
                  end
                end
                
                # Calculate H2H record summary
                h2h_summary = ''
                if matchup[:h2h_away_wins] > 0 || matchup[:h2h_away_losses] > 0
                  h2h_summary = "#{matchup[:away_fan]} #{matchup[:h2h_away_wins]}-#{matchup[:h2h_away_losses]} #{matchup[:home_fan]}"
                end
                %>
                
                <div class="featured-matchup-card-dense">
                    <!-- Header with Time and Prediction -->
                    <div class="featured-header">
                        <% if game_time_formatted && !game_time_formatted.empty? %>
                        <div class="featured-time-compact">
                            <span class="time-icon">üìÖ</span>
                            <span class="time-text"><%= game_time_formatted %></span>
                        </div>
                        <% end %>
                        <% if !predicted_winner.empty? %>
                        <div class="featured-prediction-compact" title="Based on points differential and current form">
                            <span>üîÆ</span>
                            <span>Prediction: <%= predicted_winner %> (<%= prediction_confidence %> confidence)</span>
                        </div>
                        <% end %>
                    </div>
                    
                    <!-- Main matchup with teams and inline stats -->
                    <div class="featured-teams-dense">
                        <!-- Away Team -->
                        <div class="featured-team-dense">
                            <div class="featured-team-header-dense">
                                <% if matchup[:away_abbrev] %>
                                    <img src="<%= get_team_logo_url(matchup[:away_abbrev]) %>" 
                                         alt="<%= matchup[:away_team] %> logo" 
                                         class="featured-logo-dense"
                                         onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="logo-fallback-dense" style="display:none;"><%= matchup[:away_abbrev] %></div>
                                <% end %>
                                <div class="featured-team-identity">
                                    <div class="featured-fan-name-dense"><%= matchup[:away_fan] %></div>
                                    <div class="featured-team-name-dense"><%= matchup[:away_team] %></div>
                                    <% if away_achievement %>
                                    <div class="featured-badge-dense">
                                        <span><%= away_achievement[:emoji] %></span>
                                        <span><%= away_achievement[:label] %></span>
                                    </div>
                                    <% end %>
                                </div>
                            </div>
                            <div class="featured-stats-grid">
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:away_wins] %>-<%= matchup[:away_losses] %>-<%= matchup[:away_ot_losses] %></span>
                                    <span class="stat-label-dense">Record</span>
                                </div>
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:away_points] %></span>
                                    <span class="stat-label-dense">Pts</span>
                                </div>
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:away_gpg] %></span>
                                    <span class="stat-label-dense">GPG</span>
                                </div>
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:away_streak] %></span>
                                    <span class="stat-label-dense">Streak</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- VS Divider -->
                        <div class="featured-vs-dense">VS</div>
                        
                        <!-- Home Team -->
                        <div class="featured-team-dense">
                            <div class="featured-team-header-dense">
                                <% if matchup[:home_abbrev] %>
                                    <img src="<%= get_team_logo_url(matchup[:home_abbrev]) %>" 
                                         alt="<%= matchup[:home_team] %> logo" 
                                         class="featured-logo-dense"
                                         onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="logo-fallback-dense" style="display:none;"><%= matchup[:home_abbrev] %></div>
                                <% end %>
                                <div class="featured-team-identity">
                                    <div class="featured-fan-name-dense"><%= matchup[:home_fan] %></div>
                                    <div class="featured-team-name-dense"><%= matchup[:home_team] %></div>
                                    <% if home_achievement %>
                                    <div class="featured-badge-dense">
                                        <span><%= home_achievement[:emoji] %></span>
                                        <span><%= home_achievement[:label] %></span>
                                    </div>
                                    <% end %>
                                </div>
                            </div>
                            <div class="featured-stats-grid">
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:home_wins] %>-<%= matchup[:home_losses] %>-<%= matchup[:home_ot_losses] %></span>
                                    <span class="stat-label-dense">Record</span>
                                </div>
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:home_points] %></span>
                                    <span class="stat-label-dense">Pts</span>
                                </div>
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:home_gpg] %></span>
                                    <span class="stat-label-dense">GPG</span>
                                </div>
                                <div class="stat-item-dense">
                                    <span class="stat-value-dense"><%= matchup[:home_streak] %></span>
                                    <span class="stat-label-dense">Streak</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Info Row -->
                    <div class="featured-info-row">
                        <% if !h2h_summary.empty? %>
                        <div class="info-badge">
                            <span class="info-icon">‚öîÔ∏è</span>
                            <span class="info-text"><%= h2h_summary %></span>
                        </div>
                        <% end %>
                        <div class="info-badge">
                            <span class="info-icon">üìä</span>
                            <span class="info-text" title="Recent form: Last 10 games record">Last 10: <%= matchup[:away_last10] %> vs <%= matchup[:home_last10] %></span>
                        </div>
                        <% if matchup[:same_division] %>
                        <div class="info-badge rivalry-badge">
                            <span class="info-icon">üî•</span>
                            <span class="info-text">Division Rival</span>
                        </div>
                        <% end %>
                    </div>
                </div>
            </div>
            <% end %>
            
            <!-- Excellence Awards -->
            <h3 class="section-heading">üåü Excellence Awards</h3>
            <div class="stats-grid" role="region" aria-label="Excellence awards">
                <% if bet_stats && bet_stats[:fan_crusher] && bet_stats[:fan_crusher].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:fan_crusher].first[:fan] %> is the fan crusher">
                        <div class="stat-emoji" aria-hidden="true">üí™</div>
                        <div class="stat-label">Fan Crusher</div>
                        <div class="stat-fan-name"><%= bet_stats[:fan_crusher].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:fan_crusher].first[:display].split(' ').first %></div>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:most_dominant] && bet_stats[:most_dominant].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:most_dominant].first[:fan] %> is most dominant">
                        <div class="stat-emoji" aria-hidden="true">üëë</div>
                        <div class="stat-label">Most Dominant</div>
                        <div class="stat-fan-name"><%= bet_stats[:most_dominant].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:most_dominant].first[:display] %></div>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:top_winners] && bet_stats[:top_winners].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:top_winners].first[:fan] %> has most wins">
                        <div class="stat-emoji" aria-hidden="true">ü•á</div>
                        <div class="stat-label">Top Winner</div>
                        <div class="stat-fan-name"><%= bet_stats[:top_winners].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:top_winners].first[:display] %></div>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:best_point_differential] && bet_stats[:best_point_differential].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:best_point_differential].first[:fan] %> has best goal differential">
                        <div class="stat-emoji" aria-hidden="true">‚ûï</div>
                        <div class="stat-label">Goal Diff Leader</div>
                        <div class="stat-fan-name"><%= bet_stats[:best_point_differential].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:best_point_differential].first[:display] %></div>
                    </div>
                <% end %>
            </div>
            
            <!-- Defense & Momentum -->
            <h3 class="section-heading">üõ°Ô∏è Defense & Momentum</h3>
            <div class="stats-grid" role="region" aria-label="Defense and momentum statistics">
                <% if bet_stats && bet_stats[:brick_wall] && bet_stats[:brick_wall].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:brick_wall].first[:fan] %> is the brick wall">
                        <div class="stat-emoji" aria-hidden="true">üß±</div>
                        <div class="stat-label">Brick Wall</div>
                        <div class="stat-fan-name"><%= bet_stats[:brick_wall].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:brick_wall].first[:display] %></div>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:shutout_king] && bet_stats[:shutout_king].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:shutout_king].first[:fan] %> is the shutout king">
                        <div class="stat-emoji" aria-hidden="true">üö´</div>
                        <div class="stat-label">Shutout King</div>
                        <div class="stat-fan-name"><%= bet_stats[:shutout_king].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:shutout_king].first[:display] %></div>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:longest_win_streak] && bet_stats[:longest_win_streak].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:longest_win_streak].first[:fan] %> is on fire">
                        <div class="stat-emoji" aria-hidden="true">üî•</div>
                        <div class="stat-label">On Fire</div>
                        <div class="stat-fan-name"><%= bet_stats[:longest_win_streak].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:longest_win_streak].first[:display] %></div>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:momentum_master] && bet_stats[:momentum_master].any? %>
                    <div class="stat-card-square" role="article" aria-label="<%= bet_stats[:momentum_master].first[:fan] %> is the momentum master">
                        <div class="stat-emoji" aria-hidden="true">‚ö°</div>
                        <div class="stat-label">Momentum Master</div>
                        <div class="stat-fan-name"><%= bet_stats[:momentum_master].first[:fan] %></div>
                        <div class="stat-value"><%= bet_stats[:momentum_master].first[:display] %></div>
                    </div>
                <% end %>
            </div>
            
            <!-- Special Achievements -->
            <h3 class="section-heading">üéØ Special Achievements</h3>
            <div class="stats-grid" role="region" aria-label="Special achievements">
                <% if bet_stats && bet_stats[:glass_cannon] && bet_stats[:glass_cannon].any? %>
                    <% is_expandable = bet_stats[:glass_cannon].length > 1 %>
                    <div class="stat-card-square achievement-card <%= 'expandable' if is_expandable %>" role="<%= is_expandable ? 'button' : 'article' %>" aria-label="Glass cannon achievement" <%= 'tabindex="0"' if is_expandable %> <%= 'aria-expanded="false"' if is_expandable %>>
                        <div class="stat-emoji" aria-hidden="true">üí•</div>
                        <div class="stat-label">Glass Cannon</div>
                        <div class="achievement-entries">
                            <% bet_stats[:glass_cannon].each_with_index do |entry, idx| %>
                                <div class="achievement-entry <%= 'hidden' if idx > 0 %>" data-rank="<%= idx + 1 %>">
                                    <div class="achievement-rank"><%= idx + 1 %>.</div>
                                    <div class="stat-fan-name"><%= entry[:fan] %></div>
                                    <div class="stat-value"><%= entry[:display] %></div>
                                </div>
                            <% end %>
                        </div>
                        <% if is_expandable %>
                            <span class="expand-toggle" aria-hidden="true">
                                <span class="expand-icon">‚ñº</span>
                            </span>
                        <% end %>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:comeback_kid] && bet_stats[:comeback_kid].any? %>
                    <% is_expandable = bet_stats[:comeback_kid].length > 1 %>
                    <div class="stat-card-square achievement-card <%= 'expandable' if is_expandable %>" role="<%= is_expandable ? 'button' : 'article' %>" aria-label="Comeback kid achievement" <%= 'tabindex="0"' if is_expandable %> <%= 'aria-expanded="false"' if is_expandable %>>
                        <div class="stat-emoji" aria-hidden="true">üéØ</div>
                        <div class="stat-label">Comeback Kid</div>
                        <div class="achievement-entries">
                            <% bet_stats[:comeback_kid].each_with_index do |entry, idx| %>
                                <div class="achievement-entry <%= 'hidden' if idx > 0 %>" data-rank="<%= idx + 1 %>">
                                    <div class="achievement-rank"><%= idx + 1 %>.</div>
                                    <div class="stat-fan-name"><%= entry[:fan] %></div>
                                    <div class="stat-value"><%= entry[:display] %></div>
                                </div>
                            <% end %>
                        </div>
                        <% if is_expandable %>
                            <span class="expand-toggle" aria-hidden="true">
                                <span class="expand-icon">‚ñº</span>
                            </span>
                        <% end %>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:overtimer] && bet_stats[:overtimer].any? %>
                    <% is_expandable = bet_stats[:overtimer].length > 1 %>
                    <div class="stat-card-square achievement-card <%= 'expandable' if is_expandable %>" role="<%= is_expandable ? 'button' : 'article' %>" aria-label="Overtimer achievement" <%= 'tabindex="0"' if is_expandable %> <%= 'aria-expanded="false"' if is_expandable %>>
                        <div class="stat-emoji" aria-hidden="true">‚è±Ô∏è</div>
                        <div class="stat-label">Overtimer</div>
                        <div class="achievement-entries">
                            <% bet_stats[:overtimer].each_with_index do |entry, idx| %>
                                <div class="achievement-entry <%= 'hidden' if idx > 0 %>" data-rank="<%= idx + 1 %>">
                                    <div class="achievement-rank"><%= idx + 1 %>.</div>
                                    <div class="stat-fan-name"><%= entry[:fan] %></div>
                                    <div class="stat-value"><%= entry[:display] %></div>
                                </div>
                            <% end %>
                        </div>
                        <% if is_expandable %>
                            <span class="expand-toggle" aria-hidden="true">
                                <span class="expand-icon">‚ñº</span>
                            </span>
                        <% end %>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:sharks_victims] && bet_stats[:sharks_victims].any? %>
                    <% is_expandable = bet_stats[:sharks_victims].length > 1 %>
                    <div class="stat-card-square achievement-card <%= 'expandable' if is_expandable %>" role="<%= is_expandable ? 'button' : 'article' %>" aria-label="Sharks victims achievement" <%= 'tabindex="0"' if is_expandable %> <%= 'aria-expanded="false"' if is_expandable %>>
                        <div class="stat-emoji" aria-hidden="true">ü¶à</div>
                        <div class="stat-label">Sharks Victims</div>
                        <div class="achievement-entries">
                            <% bet_stats[:sharks_victims].each_with_index do |entry, idx| %>
                                <div class="achievement-entry <%= 'hidden' if idx > 0 %>" data-rank="<%= idx + 1 %>">
                                    <div class="achievement-rank"><%= idx + 1 %>.</div>
                                    <div class="stat-fan-name"><%= entry[:fan] %></div>
                                    <div class="stat-value"><%= entry[:display] %></div>
                                </div>
                            <% end %>
                        </div>
                        <% if is_expandable %>
                            <span class="expand-toggle" aria-hidden="true">
                                <span class="expand-icon">‚ñº</span>
                            </span>
                        <% end %>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:predators_victims] && bet_stats[:predators_victims].any? %>
                    <% is_expandable = bet_stats[:predators_victims].length > 1 %>
                    <div class="stat-card-square achievement-card <%= 'expandable' if is_expandable %>" role="<%= is_expandable ? 'button' : 'article' %>" aria-label="Touched by a Predator achievement" <%= 'tabindex="0"' if is_expandable %> <%= 'aria-expanded="false"' if is_expandable %>>
                        <div class="stat-emoji" aria-hidden="true">üêØ</div>
                        <div class="stat-label">Touched by a Predator</div>
                        <div class="achievement-entries">
                            <% bet_stats[:predators_victims].each_with_index do |entry, idx| %>
                                <div class="achievement-entry <%= 'hidden' if idx > 0 %>" data-rank="<%= idx + 1 %>">
                                    <div class="achievement-rank"><%= idx + 1 %>.</div>
                                    <div class="stat-fan-name"><%= entry[:fan] %></div>
                                    <div class="stat-value"><%= entry[:display] %></div>
                                </div>
                            <% end %>
                        </div>
                        <% if is_expandable %>
                            <span class="expand-toggle" aria-hidden="true">
                                <span class="expand-icon">‚ñº</span>
                            </span>
                        <% end %>
                    </div>
                <% end %>
                
                <% if bet_stats && bet_stats[:worst_cup_odds] && bet_stats[:worst_cup_odds].any? %>
                    <% is_expandable = bet_stats[:worst_cup_odds].length > 1 %>
                    <div class="stat-card-square achievement-card <%= 'expandable' if is_expandable %>" role="<%= is_expandable ? 'button' : 'article' %>" aria-label="Needs help achievement" <%= 'tabindex="0"' if is_expandable %> <%= 'aria-expanded="false"' if is_expandable %> style="background-color: rgba(231, 76, 60, 0.1);">
                        <div class="stat-emoji" aria-hidden="true">üò¢</div>
                        <div class="stat-label">Needs Help</div>
                        <div class="achievement-entries">
                            <% bet_stats[:worst_cup_odds].each_with_index do |entry, idx| %>
                                <div class="achievement-entry <%= 'hidden' if idx > 0 %>" data-rank="<%= idx + 1 %>">
                                    <div class="achievement-rank"><%= idx + 1 %>.</div>
                                    <div class="stat-fan-name"><%= entry[:fan] %></div>
                                    <div class="stat-value"><%= entry[:display].split(' ').first %></div>
                                </div>
                            <% end %>
                        </div>
                        <% if is_expandable %>
                            <span class="expand-toggle" aria-hidden="true">
                                <span class="expand-icon">‚ñº</span>
                            </span>
                        <% end %>
                    </div>
                <% end %>
            </div>
        </div>

        <!-- Tab: Matchups -->
        <div id="matchups-tab" class="tab-section" role="tabpanel" aria-label="Upcoming matchups">
            <h2>Upcoming Battles</h2>
            <% if bet_stats && bet_stats[:upcoming_fan_matchups] && bet_stats[:upcoming_fan_matchups].any? %>
                <% bet_stats[:upcoming_fan_matchups].each do |matchup| %>
                    <div class="matchup-card" role="article" aria-label="Matchup between <%= matchup[:away_fan] %> and <%= matchup[:home_fan] %>">
                        <!-- Compact team header -->
                        <div class="matchup-teams">
                            <div class="matchup-team">
                                <% if matchup[:away_abbrev] %>
                                    <img src="<%= get_team_logo_url(matchup[:away_abbrev]) %>" 
                                         alt="<%= matchup[:away_team] %> logo" 
                                         class="team-logo"
                                         onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="team-logo-fallback" style="display:none;"><%= matchup[:away_abbrev] %></div>
                                <% end %>
                                <div>
                                    <div class="matchup-fan-name"><%= matchup[:away_fan] %></div>
                                    <div class="matchup-team-name"><%= matchup[:away_team] %></div>
                                </div>
                            </div>
                            <div class="matchup-vs" aria-label="versus">VS</div>
                            <div class="matchup-team">
                                <% if matchup[:home_abbrev] %>
                                    <img src="<%= get_team_logo_url(matchup[:home_abbrev]) %>" 
                                         alt="<%= matchup[:home_team] %> logo" 
                                         class="team-logo"
                                         onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="team-logo-fallback" style="display:none;"><%= matchup[:home_abbrev] %></div>
                                <% end %>
                                <div>
                                    <div class="matchup-fan-name"><%= matchup[:home_fan] %></div>
                                    <div class="matchup-team-name"><%= matchup[:home_team] %></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dense stats grid -->
                        <div class="matchup-details">
                            <!-- Record comparison with bar -->
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Record</span>
                                <span class="matchup-stat-value"><%= matchup[:away_wins] %>-<%= matchup[:away_losses] %> vs <%= matchup[:home_wins] %>-<%= matchup[:home_losses] %></span>
                                <div class="matchup-stat-bar">
                                    <span class="stat-bar-label"><%= matchup[:away_wins] %></span>
                                    <div class="stat-bar-container">
                                        <% total_wins = [matchup[:away_wins] + matchup[:home_wins], 1].max %>
                                        <% away_pct = (matchup[:away_wins].to_f / total_wins * 100).round %>
                                        <div class="stat-bar-fill away" style="width: <%= away_pct %>%;"></div>
                                    </div>
                                    <span class="stat-bar-label"><%= matchup[:home_wins] %></span>
                                </div>
                            </div>
                            
                            <!-- Points comparison with bar -->
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Points</span>
                                <span class="matchup-stat-value"><%= matchup[:away_points] %> vs <%= matchup[:home_points] %></span>
                                <div class="matchup-stat-bar">
                                    <span class="stat-bar-label"><%= matchup[:away_points] %></span>
                                    <div class="stat-bar-container">
                                        <% total_pts = [matchup[:away_points] + matchup[:home_points], 1].max %>
                                        <% away_pts_pct = (matchup[:away_points].to_f / total_pts * 100).round %>
                                        <div class="stat-bar-fill away" style="width: <%= away_pts_pct %>%;"></div>
                                    </div>
                                    <span class="stat-bar-label"><%= matchup[:home_points] %></span>
                                </div>
                            </div>
                            
                            <!-- Goals per game -->
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Goals/Game</span>
                                <span class="matchup-stat-value"><%= matchup[:away_gpg] %> vs <%= matchup[:home_gpg] %></span>
                                <div class="matchup-stat-bar">
                                    <span class="stat-bar-label"><%= matchup[:away_gpg] %></span>
                                    <div class="stat-bar-container">
                                        <% total_gpg = [matchup[:away_gpg] + matchup[:home_gpg], 0.1].max %>
                                        <% away_gpg_pct = (matchup[:away_gpg] / total_gpg * 100).round %>
                                        <div class="stat-bar-fill away" style="width: <%= away_gpg_pct %>%;"></div>
                                    </div>
                                    <span class="stat-bar-label"><%= matchup[:home_gpg] %></span>
                                </div>
                            </div>
                            
                            <!-- Goals against per game -->
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Goals Against/G</span>
                                <span class="matchup-stat-value"><%= matchup[:away_gapg] %> vs <%= matchup[:home_gapg] %></span>
                                <div class="matchup-stat-bar">
                                    <span class="stat-bar-label"><%= matchup[:away_gapg] %></span>
                                    <div class="stat-bar-container">
                                        <% total_gapg = [matchup[:away_gapg].to_f + matchup[:home_gapg].to_f, 0.1].max %>
                                        <% away_gapg_pct = (matchup[:away_gapg].to_f / total_gapg * 100).round %>
                                        <div class="stat-bar-fill" style="width: <%= away_gapg_pct %>%;"></div>
                                    </div>
                                    <span class="stat-bar-label"><%= matchup[:home_gapg] %></span>
                                </div>
                            </div>
                            
                            <!-- Head to head if available -->
                            <% if matchup[:h2h_home_wins] && matchup[:h2h_away_wins] && (matchup[:h2h_home_wins] > 0 || matchup[:h2h_away_wins] > 0) %>
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">H2H Record</span>
                                <span class="matchup-stat-value"><%= matchup[:h2h_away_wins] %>-<%= matchup[:h2h_away_losses] %> vs <%= matchup[:h2h_home_wins] %>-<%= matchup[:h2h_home_losses] %></span>
                            </div>
                            <% end %>
                            
                            <!-- Current streak with momentum indicator -->
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Momentum</span>
                                <span class="matchup-stat-value">
                                    <%
                                    away_streak_str = matchup[:away_streak].to_s.strip
                                    home_streak_str = matchup[:home_streak].to_s.strip

                                    away_momentum =
                                      if away_streak_str.start_with?('W')
                                        'hot'
                                      elsif away_streak_str.start_with?('L')
                                        'cold'
                                      elsif away_streak_str.empty?
                                        nil
                                      else
                                        nil
                                      end

                                    home_momentum =
                                      if home_streak_str.start_with?('W')
                                        'hot'
                                      elsif home_streak_str.start_with?('L')
                                        'cold'
                                      elsif home_streak_str.empty?
                                        nil
                                      else
                                        nil
                                      end
                                    %>
                                    <% if away_momentum %>
                                      <span class="momentum-indicator momentum-<%= away_momentum %>"><%= away_streak_str %></span>
                                    <% elsif !away_streak_str.empty? %>
                                      <span><%= away_streak_str %></span>
                                    <% else %>
                                      <span>‚Äî</span>
                                    <% end %>
                                    vs
                                    <% if home_momentum %>
                                      <span class="momentum-indicator momentum-<%= home_momentum %>"><%= home_streak_str %></span>
                                    <% elsif !home_streak_str.empty? %>
                                      <span><%= home_streak_str %></span>
                                    <% else %>
                                      <span>‚Äî</span>
                                    <% end %>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Win Probability Prediction -->
                        <% 
                        # Calculate win probability using helper
                        matchup_prediction = calculate_matchup_prediction(
                          matchup[:home_points],
                          matchup[:away_points],
                          matchup[:home_streak],
                          matchup[:away_streak]
                        )
                        win_prob = matchup_prediction[:home_prob]
                        %>
                        <div class="win-probability">
                            <span class="win-prob-label">Win %</span>
                            <div class="win-prob-bar">
                                <div class="win-prob-fill" style="width: <%= win_prob %>%;"></div>
                            </div>
                            <span class="win-prob-value"><%= win_prob %>%</span>
                        </div>
                    </div>
                <% end %>
            <% else %>
                <div class="card">
                    <p class="text-secondary">No upcoming fan matchups scheduled</p>
                </div>
            <% end %>
        </div>

        <!-- Tab: Standings -->
        <div id="standings-tab" class="tab-section" role="tabpanel" aria-label="Team standings">
            <h2>Team Standings</h2>
            
            <!-- Legend for playoff status indicators -->
            <div class="playoff-status-legend" role="region" aria-label="Playoff status legend">
                <span class="status-item">
                    <span role="img" aria-label="Division leader - playoff berth secured"><%= PLAYOFF_STATUS[:div_leader_1][:icon] %></span>
                    Division Leader
                </span>
                <span class="status-item">
                    <span role="img" aria-label="<%= PLAYOFF_STATUS[:wildcard_1][:aria_label] %>"><%= PLAYOFF_STATUS[:wildcard_1][:icon] %></span>
                    Wildcard
                </span>
                <span class="status-item">
                    <span role="img" aria-label="<%= PLAYOFF_STATUS[:in_hunt][:aria_label] %>"><%= PLAYOFF_STATUS[:in_hunt][:icon] %></span>
                    <%= PLAYOFF_STATUS[:in_hunt][:label_prefix] %>
                </span>
                <span class="status-item">
                    <span role="img" aria-label="<%= PLAYOFF_STATUS[:eliminated][:aria_label] %>"><%= PLAYOFF_STATUS[:eliminated][:icon] %></span>
                    <%= PLAYOFF_STATUS[:eliminated][:label_prefix] %>
                </span>
            </div>
            
            <% teams.each_with_index do |team, index| %>
                <% 
                status = playoff_status_for(team)
                status_info = PLAYOFF_STATUS[status]
                status_label = get_playoff_status_label(team, status)
                team_abbrev = team['teamAbbrev']['default']
                fan_name = manager_team_map[team_abbrev] || 'N/A'
                next_game = next_games[team_abbrev]
                next_game_utc = next_game ? next_game['startTimeUTC'] : 'TBD'
                next_game_pacific = next_game_utc != 'TBD' ? convert_utc_to_pacific(next_game_utc) : 'TBD'
                opponent_name = get_opponent_name(next_game, team_abbrev)
                is_fan_team = fan_name != 'N/A'
                
                # Determine trend based on streak
                streak_code = team['streakCode'] || ''
                trend_class = streak_code.start_with?('W') ? 'trend-up' : (streak_code.start_with?('L') ? 'trend-down' : '')
                trend_icon = streak_code.start_with?('W') ? 'üìà' : (streak_code.start_with?('L') ? 'üìâ' : '‚ûñ')
                %>
                
                <% next if !is_fan_team %>
                
                <div class="team-card" data-team-id="<%= team_abbrev %>" role="article" aria-label="<%= team['teamName']['default'] %> standings" tabindex="0">
                    <div class="team-card-main">
                        <div class="team-card-left">
                            <div class="team-rank" aria-label="Rank <%= index + 1 %>"><%= index + 1 %></div>
                            <img src="<%= get_team_logo_url(team_abbrev) %>" 
                                 alt="<%= team['teamName']['default'] %> logo" 
                                 class="team-logo"
                                 style="width: 40px; height: 40px; object-fit: contain; margin-right: 0.75rem;"
                                 onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="team-logo-fallback" style="display:none; width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.7rem;"><%= team_abbrev %></div>
                            <div class="team-info">
                                <div class="team-name"><%= team['teamName']['default'] %></div>
                                <div class="team-fan"><%= fan_name %></div>
                                <span class="status-badge status-<%= status.to_s.gsub('_', '-') %>" role="status" aria-label="<%= status_info[:aria_label] %>">
                                    <span aria-hidden="true"><%= status_info[:icon] %></span> <%= status_label %>
                                </span>
                            </div>
                        </div>
                        <div class="team-card-right">
                            <div class="team-points">
                                <div class="team-points-value"><%= team['points'] || 'N/A' %></div>
                                <div class="team-points-label">PTS</div>
                            </div>
                            <div class="team-trend <%= trend_class %>" aria-hidden="true"><%= trend_icon %></div>
                        </div>
                    </div>
                    <div class="team-card-details">
                        <%
                        # Get team-specific achievements and badges
                        team_badges = []
                        team_stats_list = []
                        
                        # Check if this team appears in any stat categories
                        if bet_stats
                            # Check for sharks victim
                            if bet_stats[:sharks_victims] && bet_stats[:sharks_victims].any?
                                sharks_victim = bet_stats[:sharks_victims].find { |sv| sv[:team_abbrev] == team_abbrev }
                                if sharks_victim
                                    team_badges << { emoji: 'ü¶à', label: 'Sharks Victim', value: sharks_victim[:display], color: 'rgba(0, 128, 128, 0.2)' }
                                end
                            end
                            
                            # Check for predators victim
                            if bet_stats[:predators_victims] && bet_stats[:predators_victims].any?
                                predators_victim = bet_stats[:predators_victims].find { |pv| pv[:team_abbrev] == team_abbrev }
                                if predators_victim
                                    team_badges << { emoji: 'üêØ', label: 'touched by a predator', value: predators_victim[:display], color: 'rgba(255, 185, 15, 0.2)' }
                                end
                            end
                            
                            # Check for best cup odds
                            if bet_stats[:best_cup_odds] && bet_stats[:best_cup_odds].any?
                                top_odds = bet_stats[:best_cup_odds].find { |stat| stat[:team_abbrev] == team_abbrev }
                                if top_odds
                                    team_badges << { emoji: 'üèÜ', label: 'Cup Contender', value: top_odds[:display].split(' ').first, color: 'rgba(255, 215, 0, 0.15)' }
                                end
                            end
                            
                            # Check for longest win streak
                            if bet_stats[:longest_win_streak] && bet_stats[:longest_win_streak].any?
                                streak = bet_stats[:longest_win_streak].find { |stat| stat[:team_abbrev] == team_abbrev }
                                if streak
                                    team_badges << { emoji: 'üî•', label: 'Hot Streak', value: streak[:display], color: 'rgba(255, 69, 0, 0.15)' }
                                end
                            end
                            
                            # Check for brick wall (best defense)
                            if bet_stats[:brick_wall] && bet_stats[:brick_wall].any?
                                brick = bet_stats[:brick_wall].find { |stat| stat[:team_abbrev] == team_abbrev }
                                if brick
                                    team_badges << { emoji: 'üß±', label: 'Brick Wall', value: brick[:display], color: 'rgba(100, 149, 237, 0.15)' }
                                end
                            end
                            
                            # Check for glass cannon (high scoring but leaky defense)
                            if bet_stats[:glass_cannon] && bet_stats[:glass_cannon].any?
                                cannon = bet_stats[:glass_cannon].find { |stat| stat[:team_abbrev] == team_abbrev }
                                if cannon
                                    team_badges << { emoji: 'üí•', label: 'Glass Cannon', value: cannon[:display], color: 'rgba(255, 140, 0, 0.15)' }
                                end
                            end
                            
                            # Check for shutout king
                            if bet_stats[:shutout_king] && bet_stats[:shutout_king].any?
                                shutout = bet_stats[:shutout_king].find { |stat| stat[:team_abbrev] == team_abbrev }
                                if shutout
                                    team_badges << { emoji: 'üö´', label: 'Shutout King', value: shutout[:display], color: 'rgba(128, 128, 128, 0.15)' }
                                end
                            end
                        end
                        
                        # Get head-to-head records vs other fans
                        h2h_records = []
                        if bet_stats && bet_stats[:head_to_head_matrix] && bet_stats[:head_to_head_matrix][team_abbrev]
                            bet_stats[:head_to_head_matrix][team_abbrev].each do |opp_abbrev, record|
                                opp_fan = manager_team_map[opp_abbrev]
                                next if opp_fan.nil? || opp_fan == 'N/A'
                                total_games = record[:wins] + record[:losses] + record[:ot_losses]
                                next if total_games == 0
                                
                                h2h_records << {
                                    opponent: opp_fan,
                                    wins: record[:wins],
                                    losses: record[:losses],
                                    ot_losses: record[:ot_losses],
                                    total: total_games
                                }
                            end
                        end
                        %>
                        
                        <% if team_badges.any? %>
                        <div class="team-badges">
                            <% team_badges.each do |badge| %>
                                <div class="achievement-badge" style="background-color: <%= badge[:color] %>;">
                                    <span class="badge-emoji"><%= badge[:emoji] %></span>
                                    <span class="badge-label"><%= badge[:label] %></span>
                                    <span class="badge-value"><%= badge[:value] %></span>
                                </div>
                            <% end %>
                        </div>
                        <% end %>
                        
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Record</span>
                                <span class="detail-value"><%= team['wins'] %>-<%= team['losses'] %>-<%= team['otLosses'] %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Point %</span>
                                <span class="detail-value"><%= team['pointPctg'] ? '%.1f' % (team['pointPctg'] * 100) : 'N/A' %>%</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Goals/Game</span>
                                <span class="detail-value"><%= team['goalsForPctg'] || 'N/A' %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Goals Against</span>
                                <span class="detail-value"><%= team['goalAgainst'] || 'N/A' %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Streak</span>
                                <span class="detail-value"><%= team['streakCode'] || 'N/A' %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Division</span>
                                <span class="detail-value"><%= team['divisionName'] %> (<%= team['divisionSequence'] %>)</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Conference</span>
                                <span class="detail-value"><%= team['conferenceName'] %> (<%= team['conferenceSequence'] %>)</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Next Game</span>
                                <span class="detail-value"><%= format_game_time(next_game_pacific) %> vs <%= opponent_name %></span>
                            </div>
                        </div>
                        
                        <% if h2h_records.any? %>
                        <div class="h2h-section">
                            <h4 class="h2h-title">üéØ Head-to-Head vs Fans</h4>
                            <div class="h2h-grid">
                                <% h2h_records.sort_by { |r| -r[:wins] }.each do |h2h| %>
                                    <div class="h2h-item">
                                        <span class="h2h-opponent"><%= h2h[:opponent] %></span>
                                        <span class="h2h-record <%= h2h[:wins] > (h2h[:losses] + h2h[:ot_losses]) ? 'winning' : 'losing' %>">
                                            <%= h2h[:wins] %>-<%= h2h[:losses] %>-<%= h2h[:ot_losses] %>
                                        </span>
                                    </div>
                                <% end %>
                            </div>
                        </div>
                        <% end %>
                    </div>
                </div>
            <% end %>
        </div>

        <!-- Tab: Playoff Odds (Sunburst Chart) -->
        <div id="playoff-odds-tab" class="tab-section" role="tabpanel" aria-label="Playoff progression odds">
            <h2 style="margin-bottom: 0.75rem; text-align: center; font-size: 1.15rem;">üèÜ Playoff Progression Odds</h2>
            
            <!-- Chart Section - Multi-Ring Doughnut Chart -->
            <div class="chart-container" style="padding: 0.75rem; margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0.25rem; text-align: center; font-size: 0.95rem; color: var(--text-secondary);">Visualization</h3>
                <p style="margin: 0 0 0.5rem 0; text-align: center; font-size: 0.75rem; color: var(--text-secondary);">
                    Inner ring = Make Playoffs ‚Ä¢ Outer ring = Win Cup
                </p>
                <div style="position: relative; height: 400px; max-width: 600px; margin: 0 auto;">
                    <canvas id="playoffOddsChart" role="img" aria-label="Multi-ring doughnut chart showing playoff progression odds for each fan team"></canvas>
                </div>
            </div>
            
            <!-- Compact Playoff Odds Summary Table -->
            <div id="playoffOddsSummary" class="playoff-odds-summary" style="margin-bottom: 1rem;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Tab: Trends (Chart) -->
        <div id="trends-tab" class="tab-section" role="tabpanel" aria-label="Standings trends chart">
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin: 0;">Fan League Standings Trend</h2>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="seasonSelector" style="font-size: 0.9rem; color: #8da1b9;">Season:</label>
                        <select id="seasonSelector" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #2a3a52; background: #1a253a; color: #8da1b9; font-size: 0.9rem;">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
                <canvas id="leagueTrendChart" role="img" aria-label="Line chart showing fan league standings trend over time"></canvas>
            </div>
        </div>

    </div>

    <!-- Fixed Bottom Navigation (Mobile Only) -->
    <nav class="bottom-nav" role="navigation" aria-label="Mobile navigation">
        <button class="nav-item active" data-tab="league" aria-label="View League tab" aria-current="page">
            <div class="nav-item-icon" aria-hidden="true">üè†</div>
            <div class="nav-item-label">League</div>
        </button>
        <button class="nav-item" data-tab="matchups" aria-label="View Matchups tab">
            <div class="nav-item-icon" aria-hidden="true">‚öîÔ∏è</div>
            <div class="nav-item-label">Matchups</div>
        </button>
        <button class="nav-item" data-tab="standings" aria-label="View Standings tab">
            <div class="nav-item-icon" aria-hidden="true">üìä</div>
            <div class="nav-item-label">Standings</div>
        </button>
        <button class="nav-item" data-tab="playoff-odds" aria-label="View Playoff Odds tab">
            <div class="nav-item-icon" aria-hidden="true">üèÜ</div>
            <div class="nav-item-label">Playoff Odds</div>
        </button>
        <button class="nav-item" data-tab="trends" aria-label="View Trends tab">
            <div class="nav-item-icon" aria-hidden="true">üìà</div>
            <div class="nav-item-label">Trends</div>
        </button>
    </nav>

    <script>
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab sections
            document.querySelectorAll('.tab-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected tab section
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Update nav item active states (mobile)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.removeAttribute('aria-current');
            });
            document.querySelectorAll(`.nav-item[data-tab="${tabName}"]`).forEach(item => {
                item.classList.add('active');
                item.setAttribute('aria-current', 'page');
            });
            
            // Update desktop tab active states
            document.querySelectorAll('.desktop-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.removeAttribute('aria-current');
            });
            document.querySelectorAll(`.desktop-tab[data-tab="${tabName}"]`).forEach(tab => {
                tab.classList.add('active');
                tab.setAttribute('aria-current', 'page');
            });
            
            // Load chart if switching to trends tab
            if (tabName === 'trends' && !window.chartLoaded) {
                loadStandingsTrendChart();
            }
            
            // Load playoff odds chart if switching to playoff-odds tab
            if (tabName === 'playoff-odds' && !window.playoffOddsChartLoaded) {
                loadPlayoffOddsChart();
            }
        }
        
        // Add click event listeners to all nav items and tabs
        document.querySelectorAll('.nav-item, .desktop-tab').forEach(item => {
            item.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
            
            // Add keyboard support (Enter and Space)
            item.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                }
            });
        });
        
        // Team card expand/collapse functionality with keyboard support
        document.querySelectorAll('.team-card').forEach(card => {
            card.addEventListener('click', function() {
                this.classList.toggle('expanded');
                // Update aria-expanded
                const isExpanded = this.classList.contains('expanded');
                this.setAttribute('aria-expanded', isExpanded);
            });
            
            // Add keyboard support
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.classList.toggle('expanded');
                    const isExpanded = this.classList.contains('expanded');
                    this.setAttribute('aria-expanded', isExpanded);
                }
            });
        });
        
        // Achievement card expand/collapse functionality
        // Function to toggle expansion state
        function toggleAchievementCard(card) {
            const entries = card.querySelectorAll('.achievement-entry');
            const isExpanded = card.classList.contains('expanded');
            const button = card.querySelector('.expand-toggle');
            
            if (isExpanded) {
                // Collapse: show only first entry
                card.classList.remove('expanded');
                entries.forEach((entry, idx) => {
                    if (idx > 0) entry.classList.add('hidden');
                });
                card.setAttribute('aria-expanded', 'false');
                // Update visual indicator (button icon)
                if (button) {
                    const expandIcon = button.querySelector('.expand-icon');
                    if (expandIcon) expandIcon.textContent = '‚ñº';
                }
            } else {
                // Expand: show all entries
                card.classList.add('expanded');
                entries.forEach(entry => entry.classList.remove('hidden'));
                card.setAttribute('aria-expanded', 'true');
                // Update visual indicator (button icon)
                if (button) {
                    const expandIcon = button.querySelector('.expand-icon');
                    if (expandIcon) expandIcon.textContent = '‚ñ≤';
                }
            }
        }
        
        // Make entire achievement card clickable
        // Attributes (role, tabindex, aria-expanded) are set in the HTML template
        document.querySelectorAll('.achievement-card.expandable').forEach(card => {
            // Click handler for entire card
            card.addEventListener('click', function(e) {
                toggleAchievementCard(this);
            });
            
            // Keyboard support for card
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleAchievementCard(this);
                }
            });
        });
        
        // Date group toggle functionality for matchups
        document.querySelectorAll('.date-group-toggle').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const groupName = this.getAttribute('data-group');
                const matchupsList = document.getElementById('matchups-' + groupName);
                const toggleIcon = this.querySelector('.toggle-icon');
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                
                if (matchupsList) {
                    if (isExpanded) {
                        matchupsList.classList.add('matchups-list-hidden');
                        this.setAttribute('aria-expanded', 'false');
                        if (toggleIcon) toggleIcon.textContent = '‚ñ∂';
                    } else {
                        matchupsList.classList.remove('matchups-list-hidden');
                        this.setAttribute('aria-expanded', 'true');
                        if (toggleIcon) toggleIcon.textContent = '‚ñº';
                    }
                }
            });
        });
        
        // Fan League Standings Trend Chart
        let chartInstance = null;
        let allHistoryData = null;
        let fanColorsData = null;
        let availableSeasonsData = null;
        
        async function loadStandingsTrendChart() {
            if (window.chartLoaded) return; // Prevent double loading
            
            try {
                // Fetch standings history, fan team colors, and available seasons
                const [historyResponse, colorsResponse, seasonsResponse] = await Promise.all([
                    fetch('standings_history.json'),
                    fetch('fan_team_colors.json'),
                    fetch('available_seasons.json')
                ]);
                
                allHistoryData = await historyResponse.json();
                fanColorsData = await colorsResponse.json();
                availableSeasonsData = await seasonsResponse.json();
                
                if (!allHistoryData || allHistoryData.length === 0) {
                    console.log('No standings history data available yet');
                    const canvas = document.getElementById('leagueTrendChart');
                    if (canvas && canvas.parentElement) {
                        canvas.parentElement.innerHTML = '<p class="text-secondary" style="text-align: center; padding: 2rem;">No trend data available yet. Check back after a few days of tracking.</p>';
                    }
                    return;
                }
                
                // Populate season selector
                const seasonSelector = document.getElementById('seasonSelector');
                seasonSelector.innerHTML = '';
                
                if (availableSeasonsData && availableSeasonsData.seasons) {
                    availableSeasonsData.seasons.forEach(season => {
                        const option = document.createElement('option');
                        option.value = season;
                        option.textContent = season;
                        if (season === availableSeasonsData.current_season) {
                            option.selected = true;
                        }
                        seasonSelector.appendChild(option);
                    });
                }
                
                // Add event listener for season selector
                seasonSelector.addEventListener('change', function() {
                    renderChartForSeason(this.value);
                });
                
                // Render chart for current season
                const initialSeason = availableSeasonsData?.current_season || (availableSeasonsData?.seasons && availableSeasonsData.seasons[0]);
                if (initialSeason) {
                    renderChartForSeason(initialSeason);
                }
                
                window.chartLoaded = true;
                
            } catch (error) {
                console.error('Error loading standings trend chart:', error);
                const canvas = document.getElementById('leagueTrendChart');
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML = '<p class="text-secondary" style="text-align: center; padding: 2rem;">Unable to load trend chart. Please try again later.</p>';
                }
            }
        }
        
        function renderChartForSeason(selectedSeason) {
            // Filter history data by selected season
            const history = allHistoryData.filter(entry => {
                // Use season field if available, otherwise determine from date
                const entrySeason = entry.season || determineSeasonFromDate(entry.date);
                return entrySeason === selectedSeason;
            });
            
            if (!history || history.length === 0) {
                console.log('No data available for season ' + selectedSeason);
                const canvas = document.getElementById('leagueTrendChart');
                if (canvas && canvas.parentElement && canvas.parentElement.parentElement) {
                    // Find just the canvas to replace
                    const chartArea = canvas.parentElement;
                    chartArea.innerHTML = '<p class="text-secondary" style="text-align: center; padding: 2rem;">No trend data available for this season yet.</p>';
                }
                return;
            }
            
            // Check if we have enough data points to show meaningful trends
            if (history.length === 1) {
                console.log('Only one data point available for season ' + selectedSeason);
                const canvas = document.getElementById('leagueTrendChart');
                if (canvas && canvas.parentElement) {
                    const date = history[0].date;
                    const chartContainer = canvas.parentElement;
                    const heading = chartContainer.querySelector('h2') || chartContainer.querySelector('div');
                    if (heading && heading.nextElementSibling === canvas) {
                        canvas.outerHTML = `
                            <div style="text-align: center; padding: 2rem;">
                                <p class="text-secondary" style="margin-bottom: 1rem;">
                                    <strong>Trend tracking started on ${date}</strong>
                                </p>
                                <p class="text-secondary" style="font-size: 0.9rem;">
                                    Trends will appear once data from multiple days is collected.<br>
                                    Check back tomorrow to see the standings trend chart!
                                </p>
                            </div>
                        `;
                    }
                }
                return;
            }
            
            // Prepare data for Chart.js
            const dates = history.map(entry => entry.date);
            
            // Get all fan names from the most recent entry
            const latestStandings = history[history.length - 1].standings;
            const fanNames = Object.keys(latestStandings).sort();
            
            // Detect mobile for responsive styling
            const MOBILE_BREAKPOINT = 768;
            const isMobile = window.innerWidth < MOBILE_BREAKPOINT;
            
            // Create datasets for each fan
            const datasets = fanNames.map(fanName => {
                const data = history.map(entry => entry.standings[fanName] || null);
                const color = fanColorsData[fanName] || '#888888';
                
                return {
                    label: fanName,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '33', // Add transparency
                    borderWidth: isMobile ? 1.5 : 2,
                    tension: 0.1,
                    pointRadius: isMobile ? 2 : 3,
                    pointHoverRadius: isMobile ? 4 : 5,
                    pointHitRadius: isMobile ? 10 : 8
                };
            });
            
            // Destroy existing chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            
            // Ensure canvas element exists
            let canvas = document.getElementById('leagueTrendChart');
            if (!canvas) {
                // Recreate canvas if it was replaced
                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    const existingMessage = chartContainer.querySelector('div[style*="text-align: center"]');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    canvas = document.createElement('canvas');
                    canvas.id = 'leagueTrendChart';
                    canvas.setAttribute('role', 'img');
                    canvas.setAttribute('aria-label', 'Line chart showing fan league standings trend over time');
                    chartContainer.appendChild(canvas);
                }
            }
            
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            // Create the chart with mobile-responsive configuration
            const ctx = canvas.getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: isMobile ? 6 : 10,
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                color: '#8da1b9',
                                boxWidth: isMobile ? 8 : 12,
                                boxHeight: isMobile ? 8 : 12
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(26, 37, 58, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#8da1b9',
                            borderColor: '#2a3a52',
                            borderWidth: 1,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                title: function(context) {
                                    return 'Date: ' + context[0].label;
                                },
                                label: function(context) {
                                    const suffix = isMobile ? ' pts' : ' points';
                                    return context.dataset.label + ': ' + context.parsed.y + suffix;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: !isMobile,
                                text: 'Date',
                                color: '#8da1b9',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                maxRotation: isMobile ? 90 : 45,
                                minRotation: isMobile ? 90 : 45,
                                color: '#8da1b9',
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                autoSkip: true,
                                maxTicksLimit: isMobile ? 8 : 12
                            },
                            grid: {
                                color: 'rgba(42, 58, 82, 0.5)',
                                display: !isMobile
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Points',
                                color: '#8da1b9',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                color: '#8da1b9',
                                font: {
                                    size: isMobile ? 9 : 11
                                }
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(42, 58, 82, 0.5)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // Helper function to determine season from date
        // Note: This logic must stay synchronized with the Ruby implementation
        // in lib/standings_history_tracker.rb#determine_season
        function determineSeasonFromDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // JavaScript months are 0-indexed
            
            // NHL season runs from October to June (e.g., 2024-10 to 2025-06)
            // Months 1-6: season started previous year
            // Months 7-12: season starts this year (includes off-season)
            if (month >= 7) {
                return `${year}-${year + 1}`;
            } else {
                return `${year - 1}-${year}`;
            }
        }
        
        // Playoff Odds Sunburst Chart
        let playoffOddsChartInstance = null;
        
        function loadPlayoffOddsChart() {
            if (window.playoffOddsChartLoaded) return;
            
            // Playoff progression data from Ruby
            const playoffData = <%= (bet_stats && bet_stats[:playoff_progression]) ? bet_stats[:playoff_progression].to_json : '{}' %>;
            
            if (Object.keys(playoffData).length === 0) {
                console.log('No playoff odds data available');
                const canvas = document.getElementById('playoffOddsChart');
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML = '<p class="text-secondary" style="text-align: center; padding: 2rem;">Playoff odds data not available yet.</p>';
                }
                return;
            }
            
            // Prepare data for sunburst/doughnut chart
            // Create datasets for each playoff stage (rings)
            const teams = Object.keys(playoffData);
            
            
            // Populate Compact Playoff Odds Summary Table
            const summaryContainer = document.getElementById('playoffOddsSummary');
            if (summaryContainer) {
                const sortedByCup = teams
                    .map(abbrev => ({
                        ...playoffData[abbrev],
                        abbrev: abbrev
                    }))
                    .sort((a, b) => (b.win_cup || 0) - (a.win_cup || 0)); // Sort by Cup odds
                
                // Function to get emoji based on percentage
                function getOddsEmoji(percentage) {
                    if (percentage >= 50) return 'üî•';
                    if (percentage >= 25) return 'üìà';
                    if (percentage >= 10) return '‚úÖ';
                    if (percentage >= 5) return 'üéØ';
                    return 'üìä';
                }
                
                let summaryHtml = `
                    <div style="background: var(--bg-card); border-radius: 8px; padding: 0.75rem; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 0.4rem 0.3rem; text-align: left; color: var(--text-secondary); font-weight: 600; font-size: 0.75rem;">Fan</th>
                                    <th style="padding: 0.4rem 0.3rem; text-align: right; color: var(--text-secondary); font-weight: 600; font-size: 0.75rem;">P-offs</th>
                                    <th style="padding: 0.4rem 0.3rem; text-align: right; color: var(--text-secondary); font-weight: 600; font-size: 0.75rem;">R2</th>
                                    <th style="padding: 0.4rem 0.3rem; text-align: right; color: var(--text-secondary); font-weight: 600; font-size: 0.75rem;">R3</th>
                                    <th style="padding: 0.4rem 0.3rem; text-align: right; color: var(--text-secondary); font-weight: 600; font-size: 0.75rem;">Finals</th>
                                    <th style="padding: 0.4rem 0.3rem; text-align: right; color: var(--text-secondary); font-weight: 600; font-size: 0.75rem;">Cup</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                sortedByCup.forEach((team, idx) => {
                    const rowBg = idx % 2 === 0 ? 'transparent' : 'rgba(255, 255, 255, 0.02)';
                    const cupOdds = team.win_cup || 0;
                    const cupEmoji = getOddsEmoji(cupOdds);
                    summaryHtml += `
                        <tr style="border-bottom: 1px solid rgba(42, 58, 82, 0.3); background: ${rowBg};">
                            <td style="padding: 0.5rem 0.3rem; color: var(--text-primary); font-weight: 500; font-size: 0.8rem;">
                                <div style="line-height: 1.2;">${team.fan}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.1rem; line-height: 1.2;">${team.team}</div>
                            </td>
                            <td style="padding: 0.5rem 0.3rem; text-align: right; color: var(--text-primary);">${(team.make_playoffs || 0).toFixed(0)}%</td>
                            <td style="padding: 0.5rem 0.3rem; text-align: right; color: var(--text-primary);">${(team.make_2nd_round || 0).toFixed(0)}%</td>
                            <td style="padding: 0.5rem 0.3rem; text-align: right; color: var(--text-primary);">${(team.make_3rd_round || 0).toFixed(0)}%</td>
                            <td style="padding: 0.5rem 0.3rem; text-align: right; color: var(--text-primary);">${(team.make_finals || 0).toFixed(0)}%</td>
                            <td style="padding: 0.5rem 0.3rem; text-align: right; font-weight: 600; color: var(--accent-green); white-space: nowrap;">
                                ${cupEmoji} ${cupOdds.toFixed(0)}%
                            </td>
                        </tr>
                    `;
                });
                
                summaryHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                summaryContainer.innerHTML = summaryHtml;
            }
            
            
            // Generate team colors
            function generateTeamColors(count) {
                const colors = [];
                const hueStep = 360 / count;
                const hueOffset = 20;
                for (let i = 0; i < count; i++) {
                    const hue = (i * hueStep + hueOffset) % 360;
                    colors.push({
                        h: hue,
                        s: 75,
                        l: 58
                    });
                }
                return colors;
            }
            
            // Convert HSL object to HSLA string with alpha
            function hslToHsla(hsl, alpha) {
                return `hsla(${hsl.h}, ${hsl.s}%, ${hsl.l}%, ${alpha})`;
            }
            
            const colors = generateTeamColors(teams.length);
            
            // Create 5 concentric rings for the stages
            const stages = ['make_playoffs', 'make_2nd_round', 'make_3rd_round', 'make_finals', 'win_cup'];
            const stageLabels = ['Make Playoffs', 'Make 2nd Round', 'Make 3rd Round', 'Make Finals', 'Win Cup'];
            
            const datasets = [];
            
            // Build datasets - each stage is a separate dataset (ring)
            stages.forEach((stage, stageIndex) => {
                const data = teams.map(teamAbbrev => playoffData[teamAbbrev][stage] || 0);
                
                datasets.push({
                    label: stageLabels[stageIndex],
                    data: data,
                    backgroundColor: colors.map(c => {
                        // Make inner rings more transparent, outer rings more opaque
                        const alpha = 0.5 + (stageIndex * 0.1);
                        return hslToHsla(c, alpha);
                    }),
                    borderColor: '#1a253a',
                    borderWidth: 2
                });
            });
            
            // Destroy existing chart if it exists
            if (playoffOddsChartInstance) {
                playoffOddsChartInstance.destroy();
                playoffOddsChartInstance = null;
            }
            
            const canvas = document.getElementById('playoffOddsChart');
            if (!canvas) {
                console.error('Playoff odds canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            playoffOddsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: teams.map(abbrev => playoffData[abbrev].fan),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 8,
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                boxWidth: 15,
                                boxHeight: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (!data.labels || !data.datasets) return [];
                                    
                                    return data.labels.map((label, i) => {
                                        const teamAbbrev = teams[i];
                                        const teamData = playoffData[teamAbbrev];
                                        const color = colors[i];
                                        
                                        return {
                                            text: `${label} ${teamData.win_cup.toFixed(0)}%`,
                                            fillStyle: hslToHsla(color, 0.8),
                                            strokeStyle: hslToHsla(color, 1),
                                            lineWidth: 1,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 37, 58, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#8da1b9',
                            borderColor: '#2a3a52',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const teamAbbrev = teams[dataIndex];
                                    return playoffData[teamAbbrev].fan + ' - ' + playoffData[teamAbbrev].team;
                                },
                                label: function(context) {
                                    const value = context.parsed;
                                    return stageLabels[context.datasetIndex] + ': ' + value.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    cutout: '20%', // Smaller cutout for multi-ring display
                    radius: '95%'
                }
            });
            
            window.playoffOddsChartLoaded = true;
        }
        
        // Don't load chart on page load - only when trends tab is clicked
        // Chart will be loaded by switchTab function
        
        // Register Service Worker for offline caching and performance
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('ServiceWorker registered'))
                    .catch(err => console.log('ServiceWorker registration failed:', err));
            });
        }
    </script>
</body>
</html>
