<%# filepath: /workspaces/hockey_bet/lib/standings.html.erb %>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>NHL Fan League</title>
    <link rel='stylesheet' href='styles.css'>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Home Screen App Icons and Meta -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NHL Fan League">
    <meta name="theme-color" content="#0b162a">
    
    <!-- Chart.js - Vendored -->
    <script src="vendor/chart.umd.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="mb-3">
            <h1>üèí NHL Fan League</h1>
            <p class="text-secondary" style="font-size: 0.9rem;">Last updated: <%= Time.parse(last_updated.to_s).strftime("%Y-%m-%d %H:%M:%S") %> PT</p>
        </header>

        <!-- Desktop Tabs (hidden on mobile) -->
        <div class="desktop-tabs" style="display: none;">
            <button class="desktop-tab active" data-tab="league">League</button>
            <button class="desktop-tab" data-tab="matchups">Matchups</button>
            <button class="desktop-tab" data-tab="standings">Standings</button>
            <button class="desktop-tab" data-tab="trends">Trends</button>
        </div>

        <!-- Tab: League (Fan Stats Dashboard) -->
        <div id="league-tab" class="tab-section active">
            <!-- Horizontal Scrolling Stat Cards -->
            <h2>Top Performers</h2>
            <div class="carousel-container">
                <div class="carousel">
                    <% if bet_stats && bet_stats[:best_cup_odds] && bet_stats[:best_cup_odds].any? %>
                        <% bet_stats[:best_cup_odds].first(3).each do |stat| %>
                        <div class="stat-card-square">
                            <div class="stat-emoji">üèÜ</div>
                            <div class="stat-label">Best Cup Odds</div>
                            <div class="stat-fan-name"><%= stat[:fan] %></div>
                            <div class="stat-value"><%= stat[:display].split(' ').first %></div>
                        </div>
                        <% end %>
                    <% end %>
                    
                    <% if bet_stats && bet_stats[:fan_crusher] && bet_stats[:fan_crusher].any? %>
                        <div class="stat-card-square">
                            <div class="stat-emoji">üí™</div>
                            <div class="stat-label">Fan Crusher</div>
                            <div class="stat-fan-name"><%= bet_stats[:fan_crusher].first[:fan] %></div>
                            <div class="stat-value"><%= bet_stats[:fan_crusher].first[:display].split(' ').first %></div>
                        </div>
                    <% end %>
                    
                    <% if bet_stats && bet_stats[:most_dominant] && bet_stats[:most_dominant].any? %>
                        <div class="stat-card-square">
                            <div class="stat-emoji">üëë</div>
                            <div class="stat-label">Most Dominant</div>
                            <div class="stat-fan-name"><%= bet_stats[:most_dominant].first[:fan] %></div>
                            <div class="stat-value"><%= bet_stats[:most_dominant].first[:display] %></div>
                        </div>
                    <% end %>
                    
                    <% if bet_stats && bet_stats[:brick_wall] && bet_stats[:brick_wall].any? %>
                        <div class="stat-card-square">
                            <div class="stat-emoji">üß±</div>
                            <div class="stat-label">Brick Wall</div>
                            <div class="stat-fan-name"><%= bet_stats[:brick_wall].first[:fan] %></div>
                            <div class="stat-value"><%= bet_stats[:brick_wall].first[:display] %></div>
                        </div>
                    <% end %>
                    
                    <% if bet_stats && bet_stats[:longest_win_streak] && bet_stats[:longest_win_streak].any? %>
                        <div class="stat-card-square">
                            <div class="stat-emoji">üî•</div>
                            <div class="stat-label">On Fire</div>
                            <div class="stat-fan-name"><%= bet_stats[:longest_win_streak].first[:fan] %></div>
                            <div class="stat-value"><%= bet_stats[:longest_win_streak].first[:display] %></div>
                        </div>
                    <% end %>
                    
                    <% if bet_stats && bet_stats[:worst_cup_odds] && bet_stats[:worst_cup_odds].any? %>
                        <div class="stat-card-square" style="background-color: rgba(231, 76, 60, 0.1);">
                            <div class="stat-emoji">üò¢</div>
                            <div class="stat-label">Needs Help</div>
                            <div class="stat-fan-name"><%= bet_stats[:worst_cup_odds].first[:fan] %></div>
                            <div class="stat-value"><%= bet_stats[:worst_cup_odds].first[:display].split(' ').first %></div>
                        </div>
                    <% end %>
                </div>
            </div>
            
            <!-- Playoff Status Legend -->
            <div class="card mb-2">
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <% PLAYOFF_STATUS.each do |key, status| %>
                        <span class="status-badge status-<%= key.to_s.gsub('_', '-') %>">
                            <%= status[:icon] %> <%= status[:label] %>
                        </span>
                    <% end %>
                </div>
            </div>
        </div>

        <!-- Tab: Matchups -->
        <div id="matchups-tab" class="tab-section">
            <h2>Upcoming Battles</h2>
            <% if bet_stats && bet_stats[:upcoming_fan_matchups] && bet_stats[:upcoming_fan_matchups].any? %>
                <% bet_stats[:upcoming_fan_matchups].each do |matchup| %>
                    <div class="matchup-card">
                        <div class="matchup-teams">
                            <div class="matchup-team">
                                <div class="matchup-team-name"><%= matchup[:away_team] %></div>
                                <div class="matchup-fan-name"><%= matchup[:away_fan] %></div>
                            </div>
                            <div class="matchup-vs">VS</div>
                            <div class="matchup-team">
                                <div class="matchup-team-name"><%= matchup[:home_team] %></div>
                                <div class="matchup-fan-name"><%= matchup[:home_fan] %></div>
                            </div>
                        </div>
                        <div class="matchup-details">
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Record</span>
                                <span class="matchup-stat-value"><%= matchup[:away_wins] %>W vs <%= matchup[:home_wins] %>W</span>
                            </div>
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Points</span>
                                <span class="matchup-stat-value"><%= matchup[:away_points] %> vs <%= matchup[:home_points] %></span>
                            </div>
                            <% if matchup[:game_time] && matchup[:game_time] != 'None' && matchup[:game_time] != 'TBD' %>
                            <div class="matchup-stat">
                                <span class="matchup-stat-label">Game Time</span>
                                <span class="matchup-stat-value"><%= format_game_time_full(convert_utc_to_pacific(matchup[:game_time])) %></span>
                            </div>
                            <% end %>
                        </div>
                    </div>
                <% end %>
            <% else %>
                <div class="card">
                    <p class="text-secondary">No upcoming fan matchups scheduled</p>
                </div>
            <% end %>
        </div>

        <!-- Tab: Standings -->
        <div id="standings-tab" class="tab-section">
            <h2>Team Standings</h2>
            <% teams.each_with_index do |team, index| %>
                <% 
                status = playoff_status_for(team)
                status_info = PLAYOFF_STATUS[status]
                team_abbrev = team['teamAbbrev']['default']
                fan_name = manager_team_map[team_abbrev] || 'N/A'
                next_game = next_games[team_abbrev]
                next_game_utc = next_game ? next_game['startTimeUTC'] : 'TBD'
                next_game_pacific = next_game_utc != 'TBD' ? convert_utc_to_pacific(next_game_utc) : 'TBD'
                opponent_name = get_opponent_name(next_game, team_abbrev)
                is_fan_team = fan_name != 'N/A'
                
                # Determine trend based on streak
                streak_code = team['streakCode'] || ''
                trend_class = streak_code.start_with?('W') ? 'trend-up' : (streak_code.start_with?('L') ? 'trend-down' : '')
                trend_icon = streak_code.start_with?('W') ? 'üìà' : (streak_code.start_with?('L') ? 'üìâ' : '‚ûñ')
                %>
                
                <% next if !is_fan_team %>
                
                <div class="team-card" data-team-id="<%= team_abbrev %>">
                    <div class="team-card-main">
                        <div class="team-card-left">
                            <div class="team-rank"><%= index + 1 %></div>
                            <div class="team-info">
                                <div class="team-name"><%= team['teamName']['default'] %></div>
                                <div class="team-fan"><%= fan_name %></div>
                                <span class="status-badge status-<%= status.to_s.gsub('_', '-') %>">
                                    <%= status_info[:icon] %> <%= status_info[:label] %>
                                </span>
                            </div>
                        </div>
                        <div class="team-card-right">
                            <div class="team-points">
                                <div class="team-points-value"><%= team['points'] || 'N/A' %></div>
                                <div class="team-points-label">PTS</div>
                            </div>
                            <div class="team-trend <%= trend_class %>"><%= trend_icon %></div>
                        </div>
                    </div>
                    <div class="team-card-details">
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Record</span>
                                <span class="detail-value"><%= team['wins'] %>-<%= team['losses'] %>-<%= team['otLosses'] %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Point %</span>
                                <span class="detail-value"><%= team['pointPctg'] ? '%.1f' % (team['pointPctg'] * 100) : 'N/A' %>%</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Goals/Game</span>
                                <span class="detail-value"><%= team['goalsForPctg'] || 'N/A' %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Goals Against</span>
                                <span class="detail-value"><%= team['goalAgainst'] || 'N/A' %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Streak</span>
                                <span class="detail-value"><%= team['streakCode'] || 'N/A' %></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Division</span>
                                <span class="detail-value"><%= team['divisionName'] %> (<%= team['divisionSequence'] %>)</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Conference</span>
                                <span class="detail-value"><%= team['conferenceName'] %> (<%= team['conferenceSequence'] %>)</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Next Game</span>
                                <span class="detail-value"><%= format_game_time(next_game_pacific) %> vs <%= opponent_name %></span>
                            </div>
                        </div>
                    </div>
                </div>
            <% end %>
        </div>

        <!-- Tab: Trends (Chart) -->
        <div id="trends-tab" class="tab-section">
            <div class="chart-container">
                <h2>Fan League Standings Trend</h2>
                <canvas id="leagueTrendChart"></canvas>
            </div>
        </div>

    </div>

    <!-- Fixed Bottom Navigation (Mobile Only) -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-tab="league">
            <div class="nav-item-icon">üè†</div>
            <div class="nav-item-label">League</div>
        </button>
        <button class="nav-item" data-tab="matchups">
            <div class="nav-item-icon">‚öîÔ∏è</div>
            <div class="nav-item-label">Matchups</div>
        </button>
        <button class="nav-item" data-tab="standings">
            <div class="nav-item-icon">üìä</div>
            <div class="nav-item-label">Standings</div>
        </button>
        <button class="nav-item" data-tab="trends">
            <div class="nav-item-icon">üìà</div>
            <div class="nav-item-label">Trends</div>
        </button>
    </nav>

    <!-- Original bet stats and table (hidden on mobile, shown on desktop as fallback) -->
    <div class="old-table-view">

    <!-- Bet Stats Section -->
    <% if bet_stats && bet_stats[:top_winners] && bet_stats[:top_winners].any? %>
    <div class="bet-stats-section border rounded-2 p-3 mb-3 color-bg-subtle">
        <h2 class='h3 mb-3'>üèÜ Fan League Stats & Bragging Rights üèÜ</h2>
        
        <div class="stats-grid">
            <!-- Stanley Cup Odds - Best -->
            <% if bet_stats[:best_cup_odds] && bet_stats[:best_cup_odds].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-success-emphasis">
                <h3 class='h4 color-fg-on-emphasis'>üèÜ Best Stanley Cup Odds üèÜ</h3>
                <ul class="list-style-none">
                    <% bet_stats[:best_cup_odds].each_with_index do |stat, idx| %>
                        <li class="py-1 color-fg-on-emphasis">
                            <span class="stat-medal"><%= ['ü•á', 'ü•à', 'ü•â'][idx] %></span>
                            <strong><%= stat[:fan] %></strong> (<%= stat[:team] %>): <%= stat[:display] %>
                        </li>
                    <% end %>
                </ul>
            </div>
            <% end %>

            <!-- Stanley Cup Odds - Worst -->
            <% if bet_stats[:worst_cup_odds] && bet_stats[:worst_cup_odds].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-danger-emphasis">
                <h3 class='h4 color-fg-on-emphasis'>üòî Worst Stanley Cup Odds üòî</h3>
                <ul class="list-style-none">
                    <% bet_stats[:worst_cup_odds].each_with_index do |stat, idx| %>
                        <li class="py-1 color-fg-on-emphasis">
                            <span class="stat-medal"><%= ['ü•Ä', 'üíî', 'üò¢'][idx] %></span>
                            <strong><%= stat[:fan] %></strong> (<%= stat[:team] %>): <%= stat[:display] %>
                        </li>
                    <% end %>
                </ul>
            </div>
            <% end %>

            <!-- Top Winners -->
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Top Winners</h3>
                <ul class="list-style-none">
                    <% bet_stats[:top_winners].each_with_index do |stat, idx| %>
                        <li class="py-1">
                            <span class="stat-medal"><%= ['ü•á', 'ü•à', 'ü•â'][idx] %></span>
                            <strong><%= stat[:fan] %></strong> (<%= stat[:team] %>): <%= stat[:display] %> wins
                        </li>
                    <% end %>
                </ul>
            </div>

            <!-- Top Losers -->
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-danger'>Most Losses (Wall of Shame)</h3>
                <ul class="list-style-none">
                    <% bet_stats[:top_losers].each_with_index do |stat, idx| %>
                        <li class="py-1">
                            <span class="stat-medal"><%= ['üí©', 'ü§¶', 'üò¢'][idx] %></span>
                            <strong><%= stat[:fan] %></strong> (<%= stat[:team] %>): <%= stat[:display] %> losses
                        </li>
                    <% end %>
                </ul>
            </div>

            <!-- Most Dominant -->
            <% if bet_stats[:most_dominant] && bet_stats[:most_dominant].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Most Dominant üëë</h3>
                <% bet_stats[:most_dominant].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Brick Wall -->
            <% if bet_stats[:brick_wall] && bet_stats[:brick_wall].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Brick Wall üß±</h3>
                <% bet_stats[:brick_wall].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Longest Win Streak -->
            <% if bet_stats[:longest_win_streak] && bet_stats[:longest_win_streak].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>On Fire üî•</h3>
                <% bet_stats[:longest_win_streak].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Longest Lose Streak -->
            <% if bet_stats[:longest_lose_streak] && bet_stats[:longest_lose_streak].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-danger'>Ice Cold üßä</h3>
                <% bet_stats[:longest_lose_streak].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Best Point Differential -->
            <% if bet_stats[:best_point_differential] && bet_stats[:best_point_differential].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-success'>Best Goal Differential üéØ</h3>
                <% bet_stats[:best_point_differential].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Glass Cannon -->
            <% if bet_stats[:glass_cannon] && bet_stats[:glass_cannon].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-attention'>Glass Cannon üí•</h3>
                <% bet_stats[:glass_cannon].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Comeback Kid -->
            <% if bet_stats[:comeback_kid] && bet_stats[:comeback_kid].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-accent'>Comeback Kid üí™</h3>
                <% bet_stats[:comeback_kid].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Overtimer -->
            <% if bet_stats[:overtimer] && bet_stats[:overtimer].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-muted'>Overtimer ‚è±Ô∏è</h3>
                <% bet_stats[:overtimer].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Point Scrounger -->
            <% if bet_stats[:point_scrounger] && bet_stats[:point_scrounger].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-default">
                <h3 class='h4 color-fg-muted'>Point Scrounger ü™ô</h3>
                <% bet_stats[:point_scrounger].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Fan Crusher (Best vs other fans) -->
            <% if bet_stats[:fan_crusher] && bet_stats[:fan_crusher].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-success-subtle">
                <h3 class='h4 color-fg-success'>Fan Crusher üèÜ</h3>
                <% bet_stats[:fan_crusher].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Fan Fodder (Worst vs other fans) -->
            <% if bet_stats[:fan_fodder] && bet_stats[:fan_fodder].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-danger-subtle">
                <h3 class='h4 color-fg-danger'>Fan Fodder üéØ</h3>
                <% bet_stats[:fan_fodder].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Sharks Victims (Teams that lost to Sharks) -->
            <% if bet_stats[:sharks_victims] && bet_stats[:sharks_victims].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-severe-subtle">
                <h3 class='h4 color-fg-severe'>ü¶à Sharks Victims ü¶à</h3>
                <p class="text-small mb-2">Fans who have fallen prey to the Sharks this season</p>
                <ul class="list-style-none">
                    <% bet_stats[:sharks_victims].each do |stat| %>
                        <li class="py-1">
                            <strong><%= stat[:fan] %></strong> 
                            (<%= stat[:team] %>): 
                            <%= stat[:display] %>
                        </li>
                    <% end %>
                </ul>
            </div>
            <% end %>

            <!-- Shutout King (Best defensive performance) -->
            <% if bet_stats[:shutout_king] && bet_stats[:shutout_king].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-success-subtle">
                <h3 class='h4 color-fg-success'>Shutout King üõ°Ô∏è</h3>
                <% bet_stats[:shutout_king].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Momentum Master (Longest active point streak) -->
            <% if bet_stats[:momentum_master] && bet_stats[:momentum_master].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-accent-subtle">
                <h3 class='h4 color-fg-accent'>Momentum Master üåä</h3>
                <% bet_stats[:momentum_master].each do |stat| %>
                    <p class="mb-0">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Hall of Fame (Stanley Cup Winners in Last 6 Years) -->
            <% if bet_stats[:hall_of_fame] && bet_stats[:hall_of_fame].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border: 3px solid #DAA520;">
                <h3 class='h4' style="color: #000; font-weight: bold;">üèÜ Stanley Cup Hall of Fame üèÜ</h3>
                <p class="text-small mb-2" style="color: #000; font-weight: 600;">Fans who have won the Stanley Cup in the last 6 years</p>
                <% bet_stats[:hall_of_fame].each do |stat| %>
                    <p class="mb-1" style="color: #000; font-weight: bold; font-size: 1.1em;">
                        <%= stat[:display] %>
                        <br>
                        <span style="font-size: 0.9em; font-weight: normal;">
                            <strong><%= stat[:fan] %></strong> (<%= stat[:team] %>)
                        </span>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Dynasty Points (Multi-Year: Playoff Wins) -->
            <% if bet_stats[:dynasty_points] && bet_stats[:dynasty_points].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-done-emphasis">
                <h3 class='h4 color-fg-on-emphasis'>üëë Dynasty Points üëë</h3>
                <p class="text-small color-fg-on-emphasis mb-2">Cumulative playoff wins across all seasons</p>
                <% bet_stats[:dynasty_points].each do |stat| %>
                    <p class="mb-0 color-fg-on-emphasis">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>

            <!-- Most Improved (Multi-Year: Season-over-Season) -->
            <% if bet_stats[:most_improved] && bet_stats[:most_improved].any? %>
            <div class="stat-card border rounded-2 p-3 mb-3 color-bg-success-emphasis">
                <h3 class='h4 color-fg-on-emphasis'>üìà Most Improved üìà</h3>
                <p class="text-small color-fg-on-emphasis mb-2">Biggest improvement from last season</p>
                <% bet_stats[:most_improved].each do |stat| %>
                    <p class="mb-0 color-fg-on-emphasis">
                        <strong><%= stat[:fan] %></strong> 
                        (<%= stat[:team] %>): 
                        <%= stat[:display] %>
                    </p>
                <% end %>
            </div>
            <% end %>
        </div>

        <!-- Head-to-Head Matrix -->
        <% if bet_stats[:head_to_head_matrix] && bet_stats[:head_to_head_matrix].any? %>
        <div class="stat-card border rounded-2 p-3 mb-3 color-bg-accent-subtle">
            <h3 class='h3 color-fg-accent'>üìä Head-to-Head Records üìä</h3>
            <p class="text-small color-fg-muted mb-2">How each fan's team performed against other fan teams this season</p>
            <p class="text-small color-fg-muted mb-3"><strong>How to read:</strong> Each cell shows the row team's record vs. the column team in format <strong>Wins-Losses-OT Losses</strong> (e.g., "2-1-0" means 2 wins, 1 regulation/shootout loss, 0 overtime losses)</p>
            
            <% 
              fan_abbrevs = bet_stats[:head_to_head_matrix].keys 
              fan_list = fan_abbrevs.map { |abbrev| manager_team_map[abbrev] }
              
              # Calculate interesting matchups (teams with games played)
              # Use a hash to track seen matchups and avoid showing both directions
              seen_pairs = {}
              interesting_matchups = []
              
              fan_abbrevs.each do |team_abbrev|
                fan_abbrevs.each do |opp_abbrev|
                  next if team_abbrev == opp_abbrev
                  
                  # Create a sorted pair to identify the matchup regardless of direction
                  pair_key = [team_abbrev, opp_abbrev].sort.join('-')
                  next if seen_pairs[pair_key]
                  
                  record = bet_stats[:head_to_head_matrix][team_abbrev][opp_abbrev]
                  if record && (record[:wins] + record[:losses] + record[:ot_losses]) > 0
                    total_games = record[:wins] + record[:losses] + record[:ot_losses]
                    interesting_matchups << {
                      team: manager_team_map[team_abbrev],
                      team_abbrev: team_abbrev,
                      opponent: manager_team_map[opp_abbrev],
                      opponent_abbrev: opp_abbrev,
                      record: record,
                      total_games: total_games
                    }
                    seen_pairs[pair_key] = true
                  end
                end
              end
              interesting_matchups.sort_by! { |m| -m[:total_games] }
              top_matchups = interesting_matchups.take(10)
            %>
            
            <!-- Summary of Top Matchups -->
            <% if top_matchups.any? %>
            <div class="mb-3">
                <h4 class="h6 mb-2">üî• Most Played Matchups</h4>
                <div class="text-small">
                    <% top_matchups.each do |matchup| %>
                    <div class="mb-1">
                        <strong><%= matchup[:team] %></strong> vs <%= matchup[:opponent] %>: 
                        <span class="<%= matchup[:record][:wins] > (matchup[:record][:losses] + matchup[:record][:ot_losses]) ? 'color-fg-success' : (matchup[:record][:wins] < (matchup[:record][:losses] + matchup[:record][:ot_losses]) ? 'color-fg-danger' : 'color-fg-muted') %>">
                            <%= matchup[:record][:wins] %>-<%= matchup[:record][:losses] %>-<%= matchup[:record][:ot_losses] %>
                        </span>
                        (<%= matchup[:total_games] %> game<%= matchup[:total_games] != 1 ? 's' : '' %>)
                    </div>
                    <% end %>
                </div>
            </div>
            <% end %>
            
            <!-- Collapsible Full Matrix -->
            <details class="mb-2">
                <summary class="text-small" style="cursor: pointer; user-select: none;">
                    <strong>‚ñ∂ Show Full Head-to-Head Matrix</strong> (<%= fan_abbrevs.length %> teams)
                </summary>
                <div class="mt-3" style="overflow-x: auto;">
                    <table class="table-auto width-full text-small">
                        <thead>
                            <tr class="border-bottom">
                                <th scope="col" class="p-2 text-left">Fan</th>
                                <% fan_list.each do |fan| %>
                                    <th scope="col" class="p-2 text-center" style="min-width: 60px;"><%= fan %></th>
                                <% end %>
                            </tr>
                        </thead>
                        <tbody>
                            <% fan_abbrevs.each_with_index do |team_abbrev, idx| %>
                            <tr class="<%= 'border-bottom' if idx < fan_abbrevs.length - 1 %>">
                                <td class="p-2 text-left"><strong><%= manager_team_map[team_abbrev] %></strong></td>
                                <% fan_abbrevs.each do |opp_abbrev| %>
                                    <td class="p-2 text-center">
                                        <% if team_abbrev == opp_abbrev %>
                                            <span class="color-fg-muted">‚Äî</span>
                                        <% else %>
                                            <% record = bet_stats[:head_to_head_matrix][team_abbrev][opp_abbrev] %>
                                            <% if record && (record[:wins] + record[:losses] + record[:ot_losses]) > 0 %>
                                                <span class="<%= record[:wins] > (record[:losses] + record[:ot_losses]) ? 'color-fg-success' : (record[:wins] < (record[:losses] + record[:ot_losses]) ? 'color-fg-danger' : 'color-fg-muted') %>">
                                                    <%= record[:wins] %>-<%= record[:losses] %>-<%= record[:ot_losses] %>
                                                </span>
                                            <% else %>
                                                <span class="color-fg-muted">0-0-0</span>
                                            <% end %>
                                        <% end %>
                                    </td>
                                <% end %>
                            </tr>
                            <% end %>
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
        <% end %>

        <!-- Upcoming Fan Matchups -->
        <% if bet_stats[:upcoming_fan_matchups] && bet_stats[:upcoming_fan_matchups].any? %>
        <div class="stat-card border rounded-2 p-3 mb-3 color-bg-attention-subtle">
            <h3 class='h3 color-fg-attention'>üî• Upcoming Fan vs Fan Battles üî•</h3>
            <div class="matchups-list">
                <% bet_stats[:upcoming_fan_matchups].each_with_index do |matchup, idx| %>
                    <div class="matchup-item border-bottom py-3 <%= 'border-bottom-0' if idx == bet_stats[:upcoming_fan_matchups].size - 1 %>">
                        <div class="matchup-header mb-2">
                            <strong class="h4">
                                <%= matchup[:away_fan] %> (<%= matchup[:away_team] %>)
                                vs 
                                <%= matchup[:home_fan] %> (<%= matchup[:home_team] %>)
                            </strong>
                        </div>
                        <div class="matchup-details">
                            <span class="text-small">
                                Records: <%= matchup[:away_wins] %>W vs <%= matchup[:home_wins] %>W | 
                                Points: <%= matchup[:away_points] %> vs <%= matchup[:home_points] %>
                                <% if matchup[:game_time] && matchup[:game_time] != 'None' && matchup[:game_time] != 'TBD' %>
                                    <br>
                                    <strong>Game Time:</strong> <%= format_game_time_full(convert_utc_to_pacific(matchup[:game_time])) %>
                                <% end %>
                            </span>
                        </div>
                    </div>
                <% end %>
            </div>
        </div>
        <% end %>
    </div>
    <% end %>
    
    <!-- Fan League Standings Trend Chart -->
    <div class="chart-container border rounded-2 mb-3">
        <h2 class='h3 mb-3'>üìà Fan League Standings Trend üìà</h2>
        <canvas id="leagueTrendChart"></canvas>
    </div>
    
    <div class="responsive-table overflow-auto">
        <table class='color-shadow-large'>
            <thead class='color-bg-accent-emphasis color-fg-on-emphasis mr-1'>
                <tr>
                    <th scope='col' class='p-2 border'>Team</th>
                    <th scope='col' class='p-2 border'>Fan</th>
                    <th scope='col' class='p-2 border'>Status</th>
                    <th scope='col' class='p-2 border'>W</th>
                    <th scope='col' class='p-2 border'>L</th>
                    <th scope='col' class='p-2 border'>OTL</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Streak</th>
                    <th scope='col' class='p-2 border'>Pts</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Pt %</th>
                    <th scope='col' class='p-2 border mobile-hidden'>GPG</th>
                    <th scope='col' class='p-2 border mobile-hidden'>GA</th>
                    <th scope='col' class='p-2 border mobile-hidden'>League Rank</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Conference</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Conf. Rank</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Division</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Div. Rank</th>
                    <th scope='col' class='p-2 border mobile-hidden'>Wildcard</th>
                    <th scope='col' class='p-2 border'>Next Game</th>
                    <th scope='col' class='p-2 border'>Next Opponent</th>
                </tr>
            </thead>
            <tbody>
                <% teams.each do |team| %>
                    <% 
                    status = playoff_status_for(team)
                    status_info = PLAYOFF_STATUS[status]
                    no_fan_class = manager_team_map[team['teamAbbrev']['default']] == "N/A" ? 'no-fan-name' : ''
                    team_abbrev = team['teamAbbrev']['default']
                    next_game = next_games[team_abbrev]
                    next_game_utc = next_game ? next_game['startTimeUTC'] : 'TBD'
                    next_game_pacific = next_game_utc != 'TBD' ? convert_utc_to_pacific(next_game_utc) : 'TBD'
                    opponent_name = get_opponent_name(next_game, team_abbrev)
                    is_fan_team_opponent = next_game && next_game['isFanTeamOpponent']
                    %>
                    <tr class='<%= "#{status_info[:class]} color-fg-on-emphasis mr-1 #{no_fan_class}" %>'>
                        <td class='p-2 border'><%= team['teamName']['default'] || 'N/A' %></td>
                        <td class='p-2 border <%= manager_team_map[team_abbrev] != "N/A" ? "fan-team-indicator" : "" %>'>
                            <%= manager_team_map[team_abbrev] || 'N/A' %>
                        </td>
                        <td class='p-2 border'>
                            <span class="status-icon" aria-label="<%= status_info[:aria_label] %>" role="img">
                                <%= status_info[:icon] %>
                            </span>
                        </td>
                        <td class='p-2 border'><%= team['wins'] || 'N/A' %></td>
                        <td class='p-2 border'><%= team['losses'] || 'N/A' %></td>
                        <td class='p-2 border'><%= team['otLosses'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['streakCode'] || 'N/A' %></td>
                        <td class='p-2 border'><%= team['points'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['pointPctg'] ? '%.2f' % (team['pointPctg'] * 100) : 'N/A' %>%</td>
                        <td class='p-2 border mobile-hidden'><%= team['goalsForPctg'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['goalAgainst'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['leagueSequence'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['conferenceName'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['conferenceSequence'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['divisionName'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['divisionSequence'] || 'N/A' %></td>
                        <td class='p-2 border mobile-hidden'><%= team['wildcardSequence'] || 'N/A' %></td>
                        <td class='p-2 border'><%= format_game_time(next_game_pacific) %></td>
                        <td class='p-2 border'>
                            <%= opponent_name %>
                            <% if is_fan_team_opponent %>
                                <span aria-label="Playing against a fan-owned team" role="img">üî•</span>
                            <% end %>
                        </td>
                    </tr>
                <% end %>
            </tbody>
        </table>
    </div>
    
    <div class="border-top border-bottom border-gray-light mt-3 pt-3 pb-3">
        <button id='toggleButton' class='btn btn-primary color-bg-accent-emphasis color-fg-on-emphasis mr-1 mb-1' aria-label="Toggle showing teams without fans">
            Toggle Teams Without Fans
        </button>
        <button id='toggleStatsButton' class='btn btn-primary color-bg-accent-emphasis color-fg-on-emphasis mr-1 mb-1' aria-label="Toggle showing extended statistics">
            Toggle Extended Stats
        </button>
    </div>
    </div>
    <!-- End old table view -->

    <script>
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab sections
            document.querySelectorAll('.tab-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected tab section
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Update nav item active states (mobile)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll(`.nav-item[data-tab="${tabName}"]`).forEach(item => {
                item.classList.add('active');
            });
            
            // Update desktop tab active states
            document.querySelectorAll('.desktop-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll(`.desktop-tab[data-tab="${tabName}"]`).forEach(tab => {
                tab.classList.add('active');
            });
        }
        
        // Add click event listeners to all nav items and tabs
        document.querySelectorAll('.nav-item, .desktop-tab').forEach(item => {
            item.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });
        
        // Team card expand/collapse functionality
        document.querySelectorAll('.team-card').forEach(card => {
            card.addEventListener('click', function() {
                this.classList.toggle('expanded');
            });
        });
        
        // Show desktop tabs on larger screens
        if (window.innerWidth >= 768) {
            document.querySelector('.desktop-tabs').style.display = 'flex';
        }
        
        // Original toggle functions for old table view
        document.getElementById('toggleButton')?.addEventListener('click', function () {
            var noFanRows = document.querySelectorAll('tr.no-fan-name');
            noFanRows.forEach(function (row) {
                row.classList.toggle('hidden');
            });
        });

        document.getElementById('toggleStatsButton')?.addEventListener('click', function () {
            var statColumns = document.querySelectorAll('.mobile-hidden');
            statColumns.forEach(function (column) {
                column.style.display = (column.style.display === 'none') ? 'table-cell' : 'none';
            });
        });

        // Fan League Standings Trend Chart
        async function loadStandingsTrendChart() {
            try {
                // Fetch standings history and fan team colors
                const [historyResponse, colorsResponse] = await Promise.all([
                    fetch('standings_history.json'),
                    fetch('fan_team_colors.json')
                ]);
                
                const history = await historyResponse.json();
                const fanColors = await colorsResponse.json();
                
                if (!history || history.length === 0) {
                    console.log('No standings history data available yet');
                    return;
                }
                
                // Prepare data for Chart.js
                const dates = history.map(entry => entry.date);
                
                // Get all fan names from the most recent entry
                const latestStandings = history[history.length - 1].standings;
                const fanNames = Object.keys(latestStandings).sort();
                
                // Create datasets for each fan
                const datasets = fanNames.map(fanName => {
                    const data = history.map(entry => entry.standings[fanName] || null);
                    const color = fanColors[fanName] || '#888888';
                    
                    return {
                        label: fanName,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '33', // Add transparency
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    };
                });
                
                // Create the chart
                const ctx = document.getElementById('leagueTrendChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 10,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(context) {
                                        return 'Date: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' points';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Points'
                                },
                                beginAtZero: true
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading standings trend chart:', error);
            }
        }
        
        // Load the chart when the page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadStandingsTrendChart);
        } else {
            loadStandingsTrendChart();
        }
    </script>
</body>
</html>
